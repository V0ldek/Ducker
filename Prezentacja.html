<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prezentacja</title>
  <link rel="stylesheet" href="https://stackedit.io/style.css" />
</head>

<body class="stackedit">
  <div class="stackedit__left">
    <div class="stackedit__toc">
      
<ul>
<li><a href="#pobieżne-wprowadzenie-do-podstaw-części-c-tom-i-część-i">Pobieżne wprowadzenie do podstaw części C#, Tom I, Część I</a>
<ul>
<li><a href="#plan.">0. Plan.</a></li>
<li><a href="#co-to-c.netframeworkcorestandard...">1. Co to C#/.NET(Framework/Core/Standard)/…?</a>
<ul>
<li></li>
</ul>
</li>
<li><a href="#jak-poprawnie-c">2. Jak poprawnie C#?</a></li>
<ul style="margin-left: 10px">
<li><a href="#klasyka-gatunku">2.1 Klasyka gatunku</a></li>
<li><a href="#assembly-i-namespacey">2.2 Assembly i namespace'y</a></li>
<li><a href="#podstawowe-typy">2.3 Podstawowe typy</a></li>
<li><a href="#keyword-var">2.4 Keyword <code>var</code></a></li>
<li><a href="#pętla-foreach">2.5 Pętla <code>foreach</code></a></li>
<li><a href="#access-specifiers">2.6 Access specifiers</a></li>
<li><a href="#enums">2.7 Enums</a></li>
<li><a href="#fields">2.8 Fields</a></li>
<li><a href="#properties">2.9 Properties</a></li>
<li><a href="#metody">2.10 Metody</a></li>
<li><a href="#interfejsy">2.11 Interfejsy</a></li>
<li><a href="#klasy-abstrakcyjne">2.12 Klasy abstrakcyjne</a></li>
<li><a href="#dziedziczenie">2.13 Dziedziczenie</a></li>
<li><a href="#przeciążanie">2.14 Przeciążanie</a></li>
<li><a href="#przeładowywanie-overriding">2.15 Przeładowywanie (overriding)</a></li>
<li><a href="#hiding">2.16 Hiding</a></li>
<li><a href="#konstruktory">2.17 Konstruktory</a></li>
<li><a href="#sealed">2.18 Sealed</a></li>
<li><a href="#partial">2.19 Partial</a></li>
<li><a href="#reference-types-vs-value-types">2.20 Reference types vs Value types</a></li>
<li><a href="#wolność-równość-braterstwo">2.21 <s>Wolność</s>, równość, <s>braterstwo</s></a></li>
<li><a href="#rzutowanie">2.22 Rzutowanie</a></li>
<li><a href="#boxing">2.23 Boxing</a></li>
<li><a href="#parametry-ref-i-out">2.24 Parametry <code>ref</code> i <code>out</code></a></li>
<li><a href="#parse-i-tryparse">2.25 <code>Parse</code> i <code>TryParse</code></a></li>
<li><a href="#convert">2.26 Convert</a></li>
<li><a href="#to-be-or-not-to-be">2.27 To be, or not to be?</a></li>
<li><a href="#generics">2.28 Generics</a></li>
<li><a href="#generic-constraints">2.29 Generic constraints</a></li>
<li><a href="#nullablet">2.30 <code>Nullable&lt;T&gt;</code></a></li>
<li><a href="#kolekcje">2.31 Kolekcje</a></li>
<li><a href="#ko--i-kontrawariancja">2.32 Ko- i kontrawariancja</a></li>
<li><a href="#stringi">2.33 Stringi</a></li>
<li><a href="#więcej-o-verbatim">2.34 Więcej o verbatim</a></li>
<li><a href="#statyczne-klasy">2.35 Statyczne klasy</a></li>
<li><a href="#extension-methods">2.36 Extension methods</a></li>
<li><a href="#operatory">2.37 Operatory</a></li>
<li><a href="#przeciążanie-operatorów">2.38 Przeciążanie operatorów</a></li>
<li><a href="#indekser">2.39 Indekser</a></li>
<li><a href="#custom-cast">2.40 Custom cast</a></li>
<li><a href="#tuples-valuetuple">2.41 Tuples (ValueTuple)</a></li>
<li><a href="#wyjątki">2.42 Wyjątki</a></li>
<li><a href="#garbage-collector">2.43 Garbage collector</a></li>
<li><a href="#dispose">2.44 Dispose</a></li>
<li><a href="#finalize">2.45 Finalize</a></li>
<li><a href="#atrybuty">2.46 Atrybuty</a></li>
<li><a href="#nameof">2.47 <code>nameof</code></a></li>
<li><a href="#delegates">2.48 Delegates</a></li>
<li><a href="#lambdy">2.49 Klasyka gatunku</a></li>
<li><a href="#lazyt">2.50 <code>Lazy&lt;T&gt;</code></a></li>
<li><a href="#lokalne-metody">2.51 Lokalne metody</a></li>
<li><a href="#to-już-jest-prawie-koniec">2.52 To już jest (prawie) koniec</a></li>
</ul>
<li><a href="#yyy-na-mimie-nie-uczą-o-solid1">3. “Yyy, na MIMie nie uczą o SOLID!!!1”</a></li>
<ul style="margin-left: 10px">
<li><a href="#inversion-of-control">3.1 Inversion of Control</a></li>
<li><a href="#ioc-container--service-locator">3.2 IoC Container / Service Locator</a></li>
<li><a href="#testowanie-xunit">3.3 Testowanie (XUnit)</a></li>
</ul>
<li><a href="#jak-działa-asp-.net">4. Jak działa ASP .NET?</a></li>
<ul style="margin-left: 10px">
<li><a href="#dlaczego-asynchroniczne-przetwarzanie-jest-ważne">4.1 Dlaczego asynchroniczne przetwarzanie jest ważne?</a></li>
<li><a href="#taskt-oraz-asyncawait">4.2 <code>Task&lt;T&gt;</code> oraz <code>async</code>/<code>await</code></a></li>
<li><a href="#dygresja-task.run">4.3 Dygresja: <code>Task.Run</code></a></li>
<li><a href="#dygresja-parallel">4.4 Dygresja: <code>Parallel</code></a></li>
<li><a href="#dygresja-plinq">4.5 Dygresja: PLINQ</a></li>
<li><a href="#mvc">4.6 MVC</a></li>
<li><a href="#kontrolery-i-routing">4.7 Kontrolery i routing</a></li>
<li><a href="#widoki">4.8 Widoki</a></li>
<li><a href="#formularze-i-walidacja">4.9 Formularze i walidacja</a></li>
<li><a href="#identity">4.10 Identity</a></li>
<li><a href="#co-dalej">4.11 Co dalej?</a></li>
</ul>
<li><a href="#jak-działa-entity-framework">5. Jak działa Entity Framework?</a></li>
<ul style="margin-left: 10px">
<li><a href="#konfiguracja-bazy---encje-i-metadane">5.1 Konfiguracja bazy - encje i metadane</a></li>
<li><a href="#linq">5.2 LINQ</a></li>
<li><a href="#select---projekcja">5.3 <code>Select</code> - projekcja</a></li>
<li><a href="#where---selekcjafiltrowanie">5.4 <code>Where</code> - selekcja/filtrowanie</a></li>
<li><a href="#selectmany---spłaszczenie">5.5 <code>SelectMany</code> - spłaszczenie</a></li>
<li><a href="#groupby---grupowanie">5.6 <code>GroupBy</code> - grupowanie</a></li>
<li><a href="#orderby-thenby---sortowanie">5.7 <code>OrderBy</code>, <code>ThenBy</code> - sortowanie</a></li>
<li><a href="#join">5.8 <code>Join</code></a></li>
<li><a href="#inne">5.9 Inne</a></li>
<li><a href="#deferred-execution">5.10 Deferred execution</a></li>
<li><a href="#tolist---execute">5.11 <code>ToList()</code> - execute!</a></li>
<li><a href="#agregacje">5.12 Agregacje</a></li>
<li><a href="#first-last-single">5.13 <code>First</code>, <code>Last</code>, <code>Single</code></a></li>
<li><a href="#empty">5.14 <code>Empty</code></a></li>
<li><a href="#count">5.15 <code>Count</code></a></li>
<li><a href="#allany">5.16 <code>All</code>, <code>Any</code></a></li>
<li><a href="#query-syntax">5.17 Query syntax</a></li>
<li><a href="#linq-to-entities">5.18 LINQ to Entities</a></li>
</ul>
<li><a href="#przykładowa-apka.">6. Przykładowa apka.</a></li>
<li><a href="#koniec">Koniec</a></li>
</ul>
</li>
</ul>

    </div>
  </div>
  <div class="stackedit__right">
    <div class="stackedit__html">
      <h1 id="pobieżne-wprowadzenie-do-podstaw-części-c-tom-i-część-i">Pobieżne wprowadzenie do podstaw części C#, Tom I, Część I</h1>
<p><small>v1.1 Copyright © Mateusz Gienieczko 2019</small></p>
<h2 id="plan.">0. Plan.</h2>
<ol start="0">
<li>Plan.</li>
<li>Co to C#/.NET (Framework/Core/Standard)/CLR/ABC/XYZ?</li>
<li>Jak poprawnie C#?</li>
<li>“Yyy, na MIMie nie uczą o SOLID!!!1”</li>
<li>Jak działa ASP .NET?</li>
<li>Jak działa Entity Framework?</li>
<li>Przykładowa apka.</li>
</ol>
<h2 id="co-to-c.netframeworkcorestandard...">1. Co to C#/.NET(Framework/Core/Standard)/…?</h2>
<h4 id="c-obecnie-7.3---język-zaprojektowany-w-2000-przez-andersa-hejlsberga-dla-microsoftu.">C# (obecnie 7.3) - język zaprojektowany w 2000 przez Andersa Hejlsberga dla Microsoftu.</h4>
<h4 id="roslyn---główny-kompilator-c-open-source.">Roslyn - główny kompilator C#, open-source.</h4>
<h4 id="cli-common-language-infrastructure---specyfikacja-środowiska-i-bytecodeu-do-uruchamiania-między-innymi-c.-taka-lepsza-jvm.">CLI (<em>Common Language Infrastructure</em>) - specyfikacja środowiska i bytecode’u do uruchamiania między innymi C#. Taka lepsza JVM.</h4>
<ul>
<li>
<h5 id="clr-common-language-runtime---środowisko">CLR (<em>Common Language Runtime</em>) - środowisko</h5>
</li>
<li>
<h5 id="cil-common-intermediate-language-w-skrócie-il---bytecode-taki-pseudo-assembler">CIL (<em>Common Intermediate Language</em>, w skrócie IL) - bytecode, taki pseudo-assembler</h5>
</li>
</ul>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token punctuation">.</span>assembly Hello <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">.</span>assembly <span class="token keyword">extern</span> mscorlib <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">.</span>method <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">.</span>entrypoint
    <span class="token punctuation">.</span>maxstack <span class="token number">1</span>
    ldstr <span class="token string">"Hello, world!"</span>
    call <span class="token keyword">void</span> <span class="token punctuation">[</span>mscorlib<span class="token punctuation">]</span>System<span class="token punctuation">.</span>Console<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">)</span>
    ret
<span class="token punctuation">}</span>
</code></pre>
<p>Oczywiście nikt normalny w tym nie pisze.</p>
<h4 id="managed-code---kod-uruchamiany-na-clr.">Managed code - kod uruchamiany na CLR.</h4>
<h4 id="unmanaged-code---zewnętrzny-kod-albo-unsafe-np.-wywołana-biblioteka-w-c.">Unmanaged code - zewnętrzny kod (albo <code>unsafe</code>), np. wywołana biblioteka w C++.</h4>
<h4 id="jit-compiler-jitter---kompilator-just-in-time-kompiluje-il-do-języka-maszynowego-at-runtime.">JIT Compiler (Jitter) - kompilator Just-In-Time, kompiluje IL do języka maszynowego at runtime.</h4>
<h4 id="net-framework-obecnie-4.7.3---wielka-biblioteka-do-języków-uruchamianych-w-clr-w-tym-c.-działa-tylko-pod-windowsem.">.NET Framework (obecnie 4.7.3) - wielka biblioteka do języków uruchamianych w CLR, w tym C#. Działa tylko pod Windowsem.</h4>
<h4 id="net-core-obecnie-2.2-3.0-w-drodze---analogicznie-wielka-biblioteka-ale-wieloplatformowa-i-open-source.">.NET Core (obecnie 2.2, 3.0 w drodze) - analogicznie wielka biblioteka, ale wieloplatformowa i open-source.</h4>
<h4 id="net-standard-obecnie-2.0---standard-który-musi-spełniać-każda-implementacja-.neta-jest-więc-podzbiorem-przecięcia-frameworka-i-corea.-obejmuje-np.-podstawowe-kolekcje.">.NET Standard (obecnie 2.0) - standard, który musi spełniać każda implementacja .NETa, jest więc podzbiorem przecięcia Frameworka i Core’a. Obejmuje np. podstawowe kolekcje.</h4>
<h2 id="jak-poprawnie-c">2. Jak poprawnie C#?</h2>
<p>C# jest <strong>obiektowym</strong>, <strong>statycznie typowanym</strong>, <strong>kompilowanym</strong> językiem. Ma też najdłuższą listę obejmowanych paradygmatów jaką w życiu widziałem na Wikipedii. Jest imperatywny, deklaratywny, obiektowy, funkcyjny, generyczny, współbieżny, zajebisty i zapewne istnieje do niego biblioteka, która parzy kawę.<br>
C# jest zorientowany na bezpieczeństwo i wygodę developera. Tak długo, jak poruszamy się po świecie CLR-managed kodu najgorsze co może nas spotkać to <code>NullReferenceException</code> albo błąd logiki. Nie da się zaorać sobie kawałka pamięci, zapomnieć coś zwolnić, a momenty, w których krzyczymy na język, że jest upośledzony (vide Java) oraz takie, w których język krzyczy na nas, że jesteśmy za głupi (vide C++), są ograniczone do minimum. C# ma też wspaniałe środowisko w postaci tandemu VisualStudio + ReSharper.<br>
Ale nawet wtedy pozwala nam porzucić granice zdrowego rozsądku i udostępnia typowanie dynamiczne (<code>dynamic</code>) oraz magiczny keyword <code>unsafe</code>, który wyłącza GC, ABS i wspomaganie kierownicy.<br>
W tej prezentacji jednak nie będziemy poza rzeczone granice wychodzić.</p>
<h3 id="klasyka-gatunku">2.1 Klasyka gatunku</h3>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">namespace</span> SeeITSharp 
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloWorld</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            System<span class="token punctuation">.</span>Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Hello World!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li>Nazwy namespace’ów, klas i metod piszemy CamelCasem.</li>
<li>Każda klasa musi należeć do namespace’a, nie ma kodu poza klasami.</li>
<li><code>Main</code> może przyjmować tablicę argumentów albo i nie.</li>
</ul>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
</code></pre>
<h3 id="assembly-i-namespacey">2.2 Assembly i namespace’y</h3>
<p>Pojedyncza jednostka kompilacji w świecie .NET-u to assembly. Skompilowane assembly ma rozszerzenie <code>.dll</code> w przypadku bibliotek, a <code>.exe</code> w przypadku wykonywalnych aplikacji (czyli takich z <code>Mainem</code>).<br>
W obrębie danego assembly możemy mieć wiele namespace’ów. Można o tym myśleć jak o strukturze katalogów - katalog nadrzędny to nazwa assembly, każdy kolejny zagnieżdżony namespace to podkatalog. Kolejne namespace’y oddzielamy kropką.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">namespace</span> SeeITSharp<span class="token punctuation">.</span>MyNamespace<span class="token punctuation">.</span>MySubnamespace
<span class="token punctuation">{</span>
    <span class="token keyword">class</span> <span class="token class-name">HelloWorld</span>
    <span class="token punctuation">{</span>
        <span class="token comment">/*...*/</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Do powyższej klasy można odwołać się tzw. nazwą kwalifikowaną, zawierającą wszystkie namespace’y, czyli <code>SeeITSharp.MyNamespace.MySubnamespace.HelloWorld</code>. Można jednak pominąć nadrzędne namespace’y, a najlepiej użyć dyrektywy <code>using</code>.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">using</span> System<span class="token punctuation">;</span>

<span class="token keyword">namespace</span> SeeITSharp
<span class="token punctuation">{</span>
    <span class="token keyword">class</span> <span class="token class-name">HelloWorld</span>
    <span class="token punctuation">{</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Hello World!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// This is actually System.Console being called.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre><code>&gt; Hello World!
</code></pre>
<h3 id="podstawowe-typy">2.3 Podstawowe typy</h3>
<p>Podstawowe funkcjonalności języka są podobne jak w Javie.  Mamy garść typów wbudowanych:</p>
<ul>
<li><code>bool</code> - <code>true</code>, <code>false</code>;</li>
<li><code>byte</code> - 8 bitów;</li>
<li><code>sbyte</code> - 8 bitów ze znakiem;</li>
<li><code>char</code> - 16 bitów do przechowywania znaku w Unicode;</li>
<li><code>decimal</code> - 128 bitów z wysoką precyzją np. <code>1234.5678m</code>;</li>
<li><code>double</code> - 64 bity, double precision floating point np. <code>1234.5678</code>;</li>
<li><code>float</code> - 32 bity floating point np. <code>1234.5678f</code>;</li>
<li><code>int</code> - 32 bity ze znakiem;</li>
<li><code>uint</code> - 32 bity bez znaku;</li>
<li><code>long</code> - 64 bity ze znakiem;</li>
<li><code>ulong</code> - 64 bity bez znaku;</li>
<li><code>object</code> - korzeń hierarchii dziedziczenia wszystkich typów referencyjnych</li>
<li><code>short</code> - 16 bitów ze znakiem;</li>
<li><code>ushort</code> - 16 bitów bez znaku;</li>
<li><code>string</code> - napis.</li>
</ul>
<p>Mamy też tablice:</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> tab<span class="token punctuation">.</span>Length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> tab<span class="token punctuation">.</span>Length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Console<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre><code>&gt; 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15
</code></pre>
<p>Wielowymiarowe tablice występują w dwóch smakach: multidimensional arrays oraz jagged (z ang. poszarpany) arrays.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> jagged <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> jagged<span class="token punctuation">.</span>Length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    jagged<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token punctuation">]</span> multi <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

jagged<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
multi<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>jagged<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>multi<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre><code>&gt;  1
&gt;  1
</code></pre>
<p>Jagged to tablica tablic, multidimensional to pojedyncza tablica z magią w środku. Multidimensional powinno się używać tylko wtedy, kiedy rzeczywiście operujemy na prostokątach (vel prostopadłościanach w N wymiarach). Jagged  zawsze wtedy, kiedy możemy mieć np. różne liczby kolumn dla każdego wiersza.</p>
<h3 id="keyword-var">2.4 Keyword <code>var</code></h3>
<p>C# jest statycznie typowany, ale niekoniecznie explicitly typowane. Posiada local variable type inference, tzn. kompilator jest w stanie wywnioskować typ deklaracji na podstawie przypisania.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
</code></pre>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
</code></pre>
<p>Obie powyższe deklaracje poskutkują identycznym kodem IL. Po prawej stronie nie musi stać literał.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">var</span> line <span class="token operator">=</span> Console<span class="token punctuation">.</span><span class="token function">ReadLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Variable line is a string.</span>
</code></pre>
<p>Istnieją różne konwencje używania <code>var</code>. Bodajże najpopularniejsza głosi “używaj <code>var</code> zawsze wtedy, kiedy typ po prawej jest widoczny na pierwszy rzut oka.” Ja sam posługuję się konwencją “używaj <code>var</code> zawsze”. Jednakże w jednym wszystkie konwencje są zgodne - wbudowane typy to zawsze <code>var</code>. Wszelkie <code>inty</code>, <code>stringi</code> itp. zamieniamy na <code>var</code>.</p>
<h3 id="pętla-foreach">2.5 Pętla <code>foreach</code></h3>
<p>Do iterowania się po tablicach, a w przyszłości po <code>IEnumerable</code>, w większości przypadków używa się pętli <code>foreach</code>.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> tab<span class="token punctuation">.</span>Length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token keyword">in</span> tab<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Console<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre><code>&gt; 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15
</code></pre>
<h3 id="access-specifiers">2.6 Access specifiers</h3>
<p>Zajmijmy się w końcu klasami. W C# mamy cztery/sześć access specifiery, zależy pod jakim kątem spojrzeć.</p>
<ul>
<li><code>public</code> - widoczne wszędzie (jak w Javie)</li>
<li><code>internal</code> - widoczne w obrębie tego assembly (podobne do package-private w Javie)</li>
<li><code>protected</code> - widoczne dla mnie i wszystkiego, co po mnie dziedziczy (jak w Javie)</li>
<li><code>private</code> - widoczne dla mnie i tylko dla mnie (jak w Javie)</li>
</ul>
<p>Dodatkowo istnieją dwie wariacje:</p>
<ul>
<li><code>protected internal</code> - widoczne w obrębie tego assembly oraz dla wszystkiego, co po mnie dziedziczy (także w innym assembly)</li>
<li><code>private protected</code> - widoczne tylko w obrębie tego assembly, tylko dla mnie i tego co po mnie dziedziczy</li>
</ul>
<p>Nigdy nie zdarzyło mi się użyć tych dwóch ostatnich.</p>
<h3 id="enums">2.7 Enums</h3>
<p>Enumy w C# nie różnią się niczym specjalnym od tych w innych językach.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">enum</span> Color 
<span class="token punctuation">{</span>
    Red<span class="token punctuation">,</span>
    Yellow<span class="token punctuation">,</span>
    Green<span class="token punctuation">,</span>
    Blue<span class="token punctuation">,</span>
    Black
<span class="token punctuation">}</span>

<span class="token keyword">var</span> color <span class="token operator">=</span> Color<span class="token punctuation">.</span>Red<span class="token punctuation">;</span>
</code></pre>
<p>Enum jest tak naprawdę zmienną innego typu przebraną za enum. Tym typem domyślnie jest <code>int</code> i da się to zmienić, można też ustawić domyślne wartości.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">enum</span> Color <span class="token punctuation">:</span> <span class="token keyword">short</span>
<span class="token punctuation">{</span>
   Red <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
   Yellow <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
   Green <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span>
   Blue <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">,</span>
   Black <span class="token operator">=</span> <span class="token number">16</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> mix <span class="token operator">=</span> Color<span class="token punctuation">.</span>Red <span class="token operator">|</span> Color<span class="token punctuation">.</span>Yellow <span class="token operator">|</span> Color<span class="token punctuation">.</span>Black<span class="token punctuation">;</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>mix<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre><code>&gt; 19
</code></pre>
<h3 id="fields">2.8 Fields</h3>
<p>Pola wewnątrz klasy deklaruje się jak w Javie.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RubberDuck</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> _timesSqueaked <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token keyword">string</span> _name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">const</span> Color Color <span class="token operator">=</span> Color<span class="token punctuation">.</span>Yellow<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Pola mogą mieć domyślne wartości, tak jak wyżej.</p>
<p>Mogą one mieć dodatkowe modyfikatory.</p>
<ul>
<li><code>readonly</code> - to pole może być ustawione tylko przez domyślną wartość lub konstruktor</li>
<li><code>const</code> - compile-time constant</li>
<li><code>volatile</code> - nie przestawiaj współbieżnych readów i write’ów</li>
<li><code>static</code> - pole statyczne, nieprzypisane do żadnej instancji</li>
<li><code>unsafe</code> - that’s forbidden knowledge</li>
</ul>
<p>Kompilator widząc pole lub zmienną <code>const</code> zamienia każde jej wystąpienie na podaną wartość, stąd ograniczenie na compile-time constant.</p>
<p>Niestatyczne pola powinny być prywatne. Jak nie są prywatne, to pewnie coś poszło nie tak przy projektowaniu klasy.</p>
<p>Popularną konwencją nazewnictwa (i zalecaną przez MSDN) jest pisanie prywatnych pól _camelCasem (zaczynanym od podłogi), aczkolwiek spotyka się też zwykły camelCase. Stałe piszemy CamelCasem.</p>
<h3 id="properties">2.9 Properties</h3>
<p>Skoro pola są prywatne, to potrzebujemy getterów i setterów. W Javie piszemy własne <code>getValue()</code> <code>setValue(T)</code>, C# na szczęście jest lepszy, bo ma properties.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">private</span> <span class="token keyword">int</span> _timesSqueaked <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">int</span> TimesSqueaked
<span class="token punctuation">{</span>
    <span class="token keyword">get</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> _timesSqueaked<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">set</span>
    <span class="token punctuation">{</span>
        _timesSqueaked <span class="token operator">=</span> <span class="token keyword">value</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Oczywiście tyle linii kodu to sroga przesada, ale da się to zbić używając expression bodies (o tym więcej trochę później)</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">private</span> <span class="token keyword">int</span> _timesSqueaked <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">int</span> TimesSqueaked
<span class="token punctuation">{</span>
    <span class="token keyword">get</span> <span class="token operator">=</span><span class="token operator">&gt;</span> _timesSqueaked<span class="token punctuation">;</span>
    <span class="token keyword">set</span> <span class="token operator">=</span><span class="token operator">&gt;</span> _timesSqueaked <span class="token operator">=</span> <span class="token keyword">value</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Twórcy C# zauważyli, że po pierwsze, najczęściej nazwy property będą takie same jak ich odpowiadających pól (tylko wielką literą), a po drugie najczęściej getter i setter jest domyślny, get zwraca, set przypisuje. Dlatego da się napisać też tak:</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">int</span> TimesSqueaked <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
</code></pre>
<p>Oraz dodać domyślną wartość:</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">int</span> TimesSqueaked <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre>
<p>Ta linijka jest równoważna tym wyżej, także na poziomie IL. Możemy nawet nadać różne access specifiery:</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">int</span> TimesSqueaked <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre>
<p>Domyślnie jest taki sam jak samej property. Odwoływanie się do property jest bardzo proste:</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">var</span> duck <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Duck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
duck<span class="token punctuation">.</span>TimesSqueaked <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span> <span class="token comment">// Calls the set method.</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>duck<span class="token punctuation">.</span>TimesSqueaked<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Calls the get method.</span>
</code></pre>
<pre><code>&gt; 42
</code></pre>
<p>Jeśli property ma tylko getter i jest on jednolinijkowy, można zastosować nawet bardziej zwięzłą notację:</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">int</span> Sum <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> Number <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> AverageValue <span class="token operator">=</span><span class="token operator">&gt;</span> Sum <span class="token operator">/</span> Number<span class="token punctuation">;</span>
</code></pre>
<h3 id="metody">2.10 Metody</h3>
<p>Jakie metody są, każdy widzi. Deklarujemy typ zwracany i przyjmowane argumenty. Do instancji, na której wywołano metodę, możemy się odwołać za pomocą <code>this</code>.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Duck</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Squeak</span><span class="token punctuation">(</span><span class="token keyword">string</span> message<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Squeak! "</span> <span class="token operator">+</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>TimesSqueaked<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token comment">// This `this` is actually redundant.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Metody mogą mieć zmienną liczbę argumentów dzięki keywordowi <code>params</code>.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Duck</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> TimesSqueaked <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Squeak</span><span class="token punctuation">(</span><span class="token keyword">params</span> <span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> messages<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token keyword">var</span> message <span class="token keyword">in</span> messages<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Squeak! "</span> <span class="token operator">+</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">++</span>TimesSqueaked<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> duck <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Duck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
duck<span class="token punctuation">.</span><span class="token function">Squeak</span><span class="token punctuation">(</span><span class="token string">"One."</span><span class="token punctuation">,</span> <span class="token string">"Two."</span><span class="token punctuation">,</span> <span class="token string">"Three."</span><span class="token punctuation">,</span> <span class="token string">"Four!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre><code>&gt; Squeak! One.  
&gt; Squeak! Two.  
&gt; Squeak! Three.  
&gt; Squeak! Four!
</code></pre>
<p>Getter i setter property to pełnoprawne metody i mogą zawierać dowolną logikę. Konwencjonalnie jednak nie powinny być bardzo zasobożerne.<br>
Metody mogą też mieć parametry domyślne (ale muszą być compile-time const).</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Duck</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Squeak</span><span class="token punctuation">(</span><span class="token keyword">string</span> message <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Squeak! "</span> <span class="token operator">+</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>TimesSqueaked<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token comment">// This this is actually redundant.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> duck <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Duck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
duck<span class="token punctuation">.</span><span class="token function">Squeak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre><code>&gt; Squeak!
</code></pre>
<h3 id="interfejsy">2.11 Interfejsy</h3>
<p>Interfejsy mogą zawierać tylko i wyłącznie deklaracje publicznych metod (jest to nieprawda w C# 8). Gettery i settery to metody:</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IDuck</span>
<span class="token punctuation">{</span>
   <span class="token keyword">void</span> <span class="token function">Squeak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span> TimesSqueaked <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Klasa może implementować dowolnie wiele interfejsów. Aby implementować interfejs należy dostarczyć publiczne metody o podanych sygnaturach.</p>
<h3 id="klasy-abstrakcyjne">2.12 Klasy abstrakcyjne</h3>
<p>Klasy abstrakcyjne służą do implementacji części interfejsu i pozostawienia pewnych szczegółów dla implementujących klasy dziedziczące. Mogą posiadać metody bez implementacji. Klasa abstrakcyjna nie może zostać zainstancjonowana, ale może mieć konstruktor.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">DuckBase</span> <span class="token punctuation">:</span> IDuck
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> TimesSqueaked <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token function">DuckBase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Duck created!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Squeak</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">ProcessSqueak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">++</span>TimesSqueaked<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">protected</span> <span class="token function">ProcessSqueak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="dziedziczenie">2.13 Dziedziczenie</h3>
<p>Klasy mogą dziedziczyć po maksymalnie jednej innej klasie i implementować dowolnie wiele interfejsów. Klasy dziedziczą wszystkie metody, pola etc., nie dziedziczą jedynie ctorów (i dtorów).<br>
Każda klasa dziedziczy domyślnie po <code>System.Object</code>.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Duck</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Squeak</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Squeak!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BetterDuck</span> <span class="token punctuation">:</span> Duck
<span class="token punctuation">{</span>
<span class="token punctuation">}</span>

BetterDuck duck <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BetterDuck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
duck<span class="token punctuation">.</span><span class="token function">Squeak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre><code>&gt; Squeak!
</code></pre>
<h3 id="przeciążanie">2.14 Przeciążanie</h3>
<p>Metody można przeciążać, t.j. deklarować dwie metody o tej samej nazwie, ale z innymi parametrami i/lub z innym typem zwracanym. Kompilator wybierze najlepiej pasującą metodę at compile time.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">SqueakADuck</span><span class="token punctuation">(</span>Duck duck<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Squeak!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">SqueakADuck</span><span class="token punctuation">(</span>BetterDuck duck<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Better squeak!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

Duck duck <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Duck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
BetterDuck betterDuck <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BetterDuck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Duck betterDuckDisguisedAsANormalDuck <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BetterDuck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">SqueakADuck</span><span class="token punctuation">(</span>duck<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">SqueakADuck</span><span class="token punctuation">(</span>betterDuck<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">SqueakADuck</span><span class="token punctuation">(</span>betterDuckDisguisedAsANormalDuck<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre><code>&gt; Squeak!
&gt; Better squeak!
&gt; Squeak!
</code></pre>
<h3 id="przeładowywanie-overriding">2.15 Przeładowywanie (overriding)</h3>
<p>Metody można przeładowywać (override’ować), ale tylko jeśli w klasie bazowej były zadeklarowane jako <code>virtual</code>. Trzeba to zaznaczyć za pomocą <code>override</code>. Oczywiście mamy polimorfizm.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Duck</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">Squeak</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Squeak!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BetterDuck</span> <span class="token punctuation">:</span> Duck
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">void</span> <span class="token function">Squeak</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Better squeak!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

Duck duck <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Duck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
BetterDuck betterDuck <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BetterDuck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Duck betterDuckDisguisedAsANormalDuck <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BetterDuck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

duck<span class="token punctuation">.</span><span class="token function">Squeak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
betterDuck<span class="token punctuation">.</span><span class="token function">Squeak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
betterDuckDisguisedAsANormalDuck<span class="token punctuation">.</span><span class="token function">Squeak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre><code>&gt; Squeak!
&gt; Better squeak!
&gt; Better squeak!
</code></pre>
<p>Może się zdarzyć, że chcemy wywołać implementację z klasy bazowej. Służy do tego keyword <code>base</code>.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BetterDuck</span> <span class="token punctuation">:</span> Duck
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">void</span> <span class="token function">Squeak</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Better squeak!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">Squeak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> betterDuck <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BetterDuck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
betterDuck<span class="token punctuation">.</span><span class="token function">Squeak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre><code>&gt; Better squeak!
&gt; Squeak!
</code></pre>
<h3 id="hiding">2.16 Hiding</h3>
<p>Metodę z klasy wyżej można ukryć, ale rezygnujemy wtedy z polimorfizmu.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Duck</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">Squeak</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Squeak!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BetterDuck</span> <span class="token punctuation">:</span> Duck
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">new</span> <span class="token class-name">void</span> <span class="token function">Squeak</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Better squeak!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> betterDuck <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BetterDuck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Duck duck <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BetterDuck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

betterDuck<span class="token punctuation">.</span><span class="token function">Squeak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
duck<span class="token punctuation">.</span><span class="token function">Squeak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre><code>&gt; Better squeak!
&gt; Squeak!
</code></pre>
<h3 id="konstruktory">2.17 Konstruktory</h3>
<p>W skrócie ctor, służy do tworzenia obiektów klasy za pomocą <code>new</code>.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Duck</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token function">Duck</span><span class="token punctuation">(</span><span class="token keyword">string</span> name<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> duck <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Duck</span><span class="token punctuation">(</span><span class="token string">"Jacuś"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>duck<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre><code>&gt; Jacuś
</code></pre>
<p>Jeśli nie podamy żadnego, C# stworzy dla nas domyślny:</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token function">Duck</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Konstruktor podklasy musi wywołać jakiś konstruktor klasy bazowej, domyślnie bezparametrowy.<br>
Możemy też wywołać konstruktor z konstruktora za pomocą <code>this</code>.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Duck</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> Color Color <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">Duck</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">(</span>color<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">Duck</span><span class="token punctuation">(</span>Color color<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Color <span class="token operator">=</span> color<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Jeśli mamy bezparametrowy ctor i settery, możemy zainicjować obiekt przy konstrukcji.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Duck</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> Color Color <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> duck <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Duck</span> <span class="token punctuation">{</span> Name <span class="token operator">=</span> <span class="token string">"Jacuś"</span><span class="token punctuation">,</span> Color <span class="token operator">=</span> Color<span class="token punctuation">.</span>Yellow <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="sealed">2.18 Sealed</h3>
<p>Klasy możemy zamknąć na dziedziczenie poprzez keyword <code>sealed</code>. Można też nim zablokować dalsze przeładowywanie metody wirtualnej.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Duck</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">Squeak</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
       <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BetterDuck</span> <span class="token punctuation">:</span> Duck
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">sealed</span> <span class="token keyword">override</span> <span class="token keyword">void</span> <span class="token function">Squeak</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BestDuck</span> <span class="token punctuation">:</span> BetterDuck
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">void</span> <span class="token function">Squeak</span><span class="token punctuation">(</span><span class="token punctuation">)</span>	<span class="token comment">// Compilation error - squeak is sealed.</span>
    <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="partial">2.19 Partial</h3>
<p>Klasy, interfejsy i structy można zadeklarować jako <code>partial</code> i rozbić ich implementację na kilka plików.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token comment">// Duck.cs</span>
<span class="token keyword">public</span> <span class="token keyword">partial</span> <span class="token keyword">class</span> <span class="token class-name">Duck</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token comment">// Duck.Squeak.cs</span>
<span class="token keyword">public</span> <span class="token keyword">partial</span> <span class="token keyword">class</span> <span class="token class-name">Duck</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Squeak</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Taka deklaracja zostaje złączona w całość w czasie kompilacji. Wszystkie access specifiery muszą być zgodne, <code>sealed</code> przechodzi na cały typ, dziedziczenie po klasie przechodzi na cały typ, implementowana jest suma wszystkich interfejsów.<br>
Metody też mogą być <code>partial</code>, wtedy jeden plik podaje jej sygnaturę i <em>opcjonalnie</em> inny plik ją implementuje. Jeśli implementacja nie istnieje, metoda jest ignorowana przez kompilator.</p>
<h3 id="reference-types-vs-value-types">2.20 Reference types vs Value types</h3>
<p>W C# istnieje też keyword <code>struct</code> służący do tworzenia nowych typów. W przeciwieństwie do C++ różnica pomiędzy <code>class</code> a <code>struct</code> istnieje i jest znaczna. Klasy reprezentują reference types, structy value types.</p>
<ul>
<li><strong>Reference type</strong> - instancja tego typu zawiera referencję (wskaźnik) na blok pamięci zawierający dane obiektu; przekazanie takiej instancji np. jako parametr funkcji i zmodyfikowanie w niej czegoś poskutkuje zmianą oryginalnego obiektu</li>
</ul>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">SqueakADuck</span><span class="token punctuation">(</span>Duck duck<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    duck<span class="token punctuation">.</span><span class="token function">Squeak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> duck <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Duck</span><span class="token punctuation">(</span><span class="token string">"Jacuś"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">SqueakADuck</span><span class="token punctuation">(</span>duck<span class="token punctuation">)</span><span class="token punctuation">;</span>

Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>duck<span class="token punctuation">.</span>TimesSqueaked<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre><code>&gt; 1
</code></pre>
<ul>
<li><strong>Value type</strong> - obiekty tego typu są <em>zawsze</em> kopiowane przez wartość; wszystkie typy wbudowane poza <code>object</code> i <code>string</code> są Value types</li>
</ul>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token comment">// This struct is intentionally mutable as a bad example.</span>
<span class="token keyword">public</span> <span class="token keyword">struct</span> DuckData
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> Color color <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token function">DuckData</span><span class="token punctuation">(</span><span class="token keyword">string</span> name<span class="token punctuation">,</span> Color color<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Name <span class="token operator">=</span> name<span class="token punctuation">;</span>
        Color <span class="token operator">=</span> color<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ChangeColor</span><span class="token punctuation">(</span>DuckData data<span class="token punctuation">,</span> Color color<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    data<span class="token punctuation">.</span>Color <span class="token operator">=</span> color<span class="token punctuation">;</span>
	Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"In: "</span> <span class="token operator">+</span> data<span class="token punctuation">.</span>Color<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> duckData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DuckData</span><span class="token punctuation">(</span><span class="token string">"Jacuś"</span><span class="token punctuation">,</span> Color<span class="token punctuation">.</span>Yellow<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">ChangeColor</span><span class="token punctuation">(</span>duckData<span class="token punctuation">,</span> Color<span class="token punctuation">.</span>Red<span class="token punctuation">)</span><span class="token punctuation">;</span>

Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Out: "</span> <span class="token operator">+</span> duckData<span class="token punctuation">.</span>Color<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre><code>&gt; In: Red
&gt; Out: Yellow
</code></pre>
<p>Odwołanie się do value type <em>zawsze</em>,  <strong>zawsze</strong>, ZaWsZe zwraca kopię. Z tego powodu Value types absolutnie zawsze powinny być immutable, bez żadnych wyjątków.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">struct</span> DuckData
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> Color Color <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token function">DuckData</span><span class="token punctuation">(</span><span class="token keyword">string</span> name<span class="token punctuation">,</span> Color color<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Name <span class="token operator">=</span> name<span class="token punctuation">;</span>
        Color <span class="token operator">=</span> color<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ChangeColor</span><span class="token punctuation">(</span>Color color<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
	    <span class="token keyword">this</span><span class="token punctuation">.</span>Color <span class="token operator">=</span> color<span class="token punctuation">;</span>
		Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"In: "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Color<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Duck</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> DuckData Data <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">Duck</span><span class="token punctuation">(</span><span class="token keyword">string</span> name<span class="token punctuation">,</span> Color color<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DuckData</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> duck <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Duck</span><span class="token punctuation">(</span><span class="token string">"Jacuś"</span><span class="token punctuation">,</span> Color<span class="token punctuation">.</span>Yellow<span class="token punctuation">)</span><span class="token punctuation">;</span>

duck<span class="token punctuation">.</span>Data<span class="token punctuation">.</span><span class="token function">ChangeColor</span><span class="token punctuation">(</span>Color<span class="token punctuation">.</span>Red<span class="token punctuation">)</span><span class="token punctuation">;</span>

Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Out: "</span> <span class="token operator">+</span> duck<span class="token punctuation">.</span>Data<span class="token punctuation">.</span>Color<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre><code>&gt; In: Red
&gt; Out: Yellow
</code></pre>
<p>Ciekawostka przyrodnicza - wszystkie keywordy <code>int</code>, <code>object</code>, <code>string</code> itp. są tak naprawdę jedynie aliasami na typy <code>struct System.Int32</code>, <code>class System.Object</code>, <code>class System.String</code>.</p>
<p>Domyślną wartością reference type jest <code>null</code>,  domyślną wartością value type są wyzerowane bity. Value types nie mogą mieć bezparametrowych ctorów. Value types nie mogą po niczym dziedziczyć (ani nie można dziedziczyć po nich), ale mogą implementować interfejsy.</p>
<h3 id="wolność-równość-braterstwo">2.21 <s>Wolność</s>, równość, <s>braterstwo</s></h3>
<p>Istnieje metod <code>static bool Object.ReferenceEquals(object, object)</code>, która sprawdza, czy przekazane obiekty są tym samym. Dla value types w oczywisty sposó zawsze zwraca <code>false</code>.<br>
Istnieje metoda <code>bool Object.Equals(object)</code>, którą dziedziczą wszystkie typy. Domyślnie porównanie za pomocą <code>Equals</code> jest równoważne <code>ReferenceEquals</code> dla reference types, a dla value types porównuje każdy bit. Da się ją przeciążyć.<br>
Domyślnie porównanie za pomocą operatora <code>==</code> jest równoważna <code>ReferenceEquals</code> dla reference types i jest niezdefiniowany dla value types. Da się go przeciążyć.<br>
Wszystkie wbudowane value types mają przeciążone <code>==</code> na równoważne <code>Equals</code>. <strong>Wyjątkowo <code>string</code> również przeciąża <code>==</code> i porównuje wartości!</strong></p>
<p>Dla wydajności, przy przeciążaniu <code>Equals</code> powinno się przeciążać też <code>long Object.GetHashCode()</code> i sprawdzać najpierw go. Poniżej idiomatyczna implementacja <code>Equals</code>.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">struct</span> DuckData
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> Color Color <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">DuckData</span><span class="token punctuation">(</span><span class="token keyword">string</span> name<span class="token punctuation">,</span> Color color<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Name <span class="token operator">=</span> name<span class="token punctuation">;</span>
        Color <span class="token operator">=</span> color<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">long</span> <span class="token function">GetHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">var</span> hash <span class="token operator">=</span> <span class="token number">17</span><span class="token punctuation">;</span>
        <span class="token keyword">unchecked</span>
        <span class="token punctuation">{</span>
            hash <span class="token operator">=</span> <span class="token punctuation">(</span>hash <span class="token operator">*</span> <span class="token number">23</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>Name <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> Name<span class="token punctuation">.</span><span class="token function">GetHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            hash <span class="token operator">=</span> <span class="token punctuation">(</span>hash <span class="token operator">*</span> <span class="token number">23</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>Color <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> Name<span class="token punctuation">.</span><span class="token function">GetHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> hash<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">bool</span> <span class="token function">Equals</span><span class="token punctuation">(</span>DuckData other<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> 
	    <span class="token function">GetHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> other<span class="token punctuation">.</span><span class="token function">GetHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
	    Name <span class="token operator">==</span> other<span class="token punctuation">.</span>Name <span class="token operator">&amp;&amp;</span>
	    Color <span class="token operator">==</span> other<span class="token punctuation">.</span>Color

	<span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">bool</span> <span class="token function">Equals</span><span class="token punctuation">(</span><span class="token keyword">object</span> obj<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
	    <span class="token keyword">if</span><span class="token punctuation">(</span>obj <span class="token keyword">is</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
	    <span class="token punctuation">{</span>
	        <span class="token keyword">return</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>obj <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> obj<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">Equals</span><span class="token punctuation">(</span><span class="token punctuation">(</span>DuckData<span class="token punctuation">)</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
<span class="token punctuation">}</span>
</code></pre>
<h3 id="rzutowanie">2.22 Rzutowanie</h3>
<ul>
<li>Casty, przy których nie ma ryzyka utraty informacji są implicit.</li>
</ul>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span>
<span class="token keyword">long</span> b <span class="token operator">=</span> a<span class="token punctuation">;</span>  <span class="token comment">// Implicit cast.</span>
</code></pre>
<ul>
<li>Cast może być explicit at compile time, wtedy zawsze się udaje albo nie kompiluje.</li>
</ul>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">var</span> betterDuck <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BetterDuck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> duck <span class="token operator">=</span> <span class="token punctuation">(</span>Duck<span class="token punctuation">)</span>betterDuck<span class="token punctuation">;</span>
</code></pre>
<ul>
<li>Cast może być explicit at runtime, wtedy może rzucić <code>InvalidCastException</code>.</li>
</ul>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">var</span> duck <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Duck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> betterDuck <span class="token operator">=</span> <span class="token punctuation">(</span>BetterDuck<span class="token punctuation">)</span>duck<span class="token punctuation">;</span> <span class="token comment">// Throws at runtime.</span>
</code></pre>
<pre class=" language-csharp"><code class="prism  language-csharp">Duck duck <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BetterDuck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> betterDuck <span class="token operator">=</span> <span class="token punctuation">(</span>BetterDuck<span class="token punctuation">)</span>duck<span class="token punctuation">;</span> <span class="token comment">// Succeeds at runtime.</span>
</code></pre>
<ul>
<li>Cast może być safe at runtime z użyciem <code>as</code> lub <code>is</code>.</li>
</ul>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">var</span> duck <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Duck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> betterDuck <span class="token operator">=</span> duck <span class="token keyword">as</span> BetterDuck<span class="token punctuation">;</span> <span class="token comment">// Fails, betterDuck == null.</span>
</code></pre>
<pre class=" language-csharp"><code class="prism  language-csharp">Duck duck <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BetterDuck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> betterDuck <span class="token operator">=</span> duck <span class="token keyword">as</span> BetterDuck<span class="token punctuation">;</span> <span class="token comment">// Succeeds, duck == betterDuck.</span>
</code></pre>
<pre class=" language-csharp"><code class="prism  language-csharp">Duck duck <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BetterDuck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>duck <span class="token keyword">is</span> BetterDuck<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Success!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<pre><code>&gt; Success!
</code></pre>
<pre class=" language-csharp"><code class="prism  language-csharp">Duck duck <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BetterDuck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>duck <span class="token keyword">is</span> BetterDuck betterDuck<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    betterDuck<span class="token punctuation">.</span><span class="token function">Squeak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<pre><code>&gt; Better squeak!
</code></pre>
<pre class=" language-csharp"><code class="prism  language-csharp">Duck duck <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BetterDuck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
BetterDuck betterDuck <span class="token operator">=</span> duck <span class="token keyword">as</span> BetterDuck<span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>betterDuck <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    betterDuck<span class="token punctuation">.</span><span class="token function">Squeak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<pre><code>&gt; Better squeak!
</code></pre>
<h3 id="boxing">2.23 Boxing</h3>
<p>Przy takim przypisaniu:</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span>
<span class="token keyword">object</span> obj <span class="token operator">=</span> i<span class="token punctuation">;</span>
</code></pre>
<p>następuje boxing, czyli opakowanie value type w reference type. Operacja odwrotna to unboxing:</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>obj<span class="token punctuation">;</span>
</code></pre>
<p>Boxing zżera czas, więc należy go unikać.</p>
<h3 id="parametry-ref-i-out">2.24 Parametry <code>ref</code> i <code>out</code></h3>
<p>C# pozwala na mało eleganckie przekazywanie zmiennych przez referencję. Można więc przekazać referencję na referencję lub referencję na value type.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Nullify</span><span class="token punctuation">(</span><span class="token keyword">ref</span> Duck duck<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    duck <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Zero</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token keyword">int</span> i<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Set</span><span class="token punctuation">(</span><span class="token keyword">out</span> <span class="token keyword">int</span> i<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    i <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> duck <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Duck</span><span class="token punctuation">(</span><span class="token string">"Jacuś"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span>

<span class="token function">Nullify</span><span class="token punctuation">(</span><span class="token keyword">ref</span> duck<span class="token punctuation">)</span><span class="token punctuation">;</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>duck <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">"Null"</span> <span class="token punctuation">:</span> <span class="token string">"Not null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">Zero</span><span class="token punctuation">(</span><span class="token keyword">ref</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> j<span class="token punctuation">;</span>
<span class="token function">Set</span><span class="token punctuation">(</span><span class="token keyword">out</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre>
<pre><code>&gt; Null
&gt; 0
&gt; 42
</code></pre>
<p>Różnica między <code>ref</code> a <code>out</code> - <code>ref</code> musi być przypisany przed przekazaniem, <code>out</code> nie. Metoda musi przypisać coś do <code>out</code>, do <code>ref</code> nie.</p>
<h3 id="parse-i-tryparse">2.25 Parse i TryParse</h3>
<p>Do konwersji stringów na liczby używa się funkcji <code>Parse</code> lub <code>TryParse</code>.  Ta pierwsza rzuca wyjątek przy niepowodzeniu, ta druga zwraca <code>boola</code> i wypełnia <code>out</code> parameter jeśli się udało.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token string">"42"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">int</span> j<span class="token punctuation">;</span>
<span class="token keyword">var</span> success <span class="token operator">=</span> <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token function">TryParse</span><span class="token punctuation">(</span><span class="token string">"42"</span><span class="token punctuation">,</span> <span class="token keyword">out</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>success<span class="token punctuation">)</span><span class="token punctuation">;</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre><code>&gt; True
&gt; 42
</code></pre>
<p>Można też olać <code>out</code> parameter (nie tylko w <code>TryParse</code>, tak ogólnie) i dostać tylko <code>boola</code>.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">var</span> success <span class="token operator">=</span> <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token function">TryParse</span><span class="token punctuation">(</span><span class="token string">"42"</span><span class="token punctuation">,</span> <span class="token keyword">out</span> _<span class="token punctuation">)</span><span class="token punctuation">;</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>success<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre><code>&gt; 42
</code></pre>
<h3 id="convert">2.26 Convert</h3>
<p>Zaawansowane konwersje pomiędzy bazowymi typami powinny używać <code>Convert</code>.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">var</span> d <span class="token operator">=</span> <span class="token number">1.6</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> i <span class="token operator">=</span> Convert<span class="token punctuation">.</span><span class="token function">ToInt32</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>

Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre><code>&gt; 2
</code></pre>
<h3 id="to-be-or-not-to-be">2.27 To be, or not to be?</h3>
<p>C# ma rozbudowany mechanizm refleksji, który pozwala np. dostać metadane o typie danego obiektu at runtime.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">var</span> duck <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Duck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Type t <span class="token operator">=</span> duck<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Jeśli chcemy dostać informacje o typie statycznym at compile time, najlepiej użyć <code>typeof</code>.</p>
<pre class=" language-csharp"><code class="prism  language-csharp">Type t <span class="token operator">=</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span>Duck<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Można też np. złapać wszystkie metody dostępne dla danego typu, wszystkie interfejsy, klasy bazowe czy wyzerować wszystkie prywatne pola. Use responsibly (which means don’t use at all unless you need it).<br>
Jest też wolna, like, bardzo.</p>
<h3 id="generics">2.28 Generics</h3>
<p>Suck it, Java.<br>
Generyczne mogą być zarówno typy jak i metody. Przykładem generycznej klasy jest np. <code>List&lt;T&gt;</code>, który może przechowywać dowolne obiekty. W przeciwieństwie do pewnego języka na J, informacja o typie zostaje zachowana at compile time.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token generic-method function">PrintDuckType<span class="token punctuation">&lt;</span>TDuck<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>TDuck duck<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">var</span> typeName <span class="token operator">=</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span>TDuck<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"I was passed "</span> <span class="token operator">+</span> typeName <span class="token operator">+</span> <span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> duck <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Duck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> betterDuck <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BetterDuck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Duck betterDuckDisguisedAsADuck <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BetterDuck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">PrintDuckType</span><span class="token punctuation">(</span>duck<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">PrintDuckType</span><span class="token punctuation">(</span>betterDuck<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">PrintDuckType</span><span class="token punctuation">(</span>betterDuckDisguisedAsADuck<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre><code>&gt; I was passed Duck.
&gt; I was passed BetterDuck.
&gt; I was passed Duck.
</code></pre>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">B</span><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token punctuation">:</span> A <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">C</span> <span class="token punctuation">:</span> B<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">D</span><span class="token operator">&lt;</span>T<span class="token punctuation">,</span> U<span class="token operator">&gt;</span> <span class="token punctuation">:</span> B<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span>
</code></pre>
<p>Generyki z C# są stricte lepsze niż te z Javy, ale nie są Turing complete jak te z C++. Prawdopodobnie największym ograniczeniem jest brak variadic generics, przez co <code>System/Tuple.cs</code> wygląda jakoś tak:</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Tuple</span><span class="token operator">&lt;</span>T1<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    T1 Item1 <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token comment">/* ... */</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Tuple</span><span class="token operator">&lt;</span>T1<span class="token punctuation">,</span> T2<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    T1 Item1 <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    T2 Item2 <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token comment">/* ... */</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Tuple</span><span class="token operator">&lt;</span>T1<span class="token punctuation">,</span> T2<span class="token punctuation">,</span> T3<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    T1 Item1 <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    T2 Item2 <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    T3 Item3 <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token comment">/* ... */</span>
<span class="token punctuation">}</span>

<span class="token comment">/* ... */</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Tuple</span><span class="token operator">&lt;</span>T1<span class="token punctuation">,</span> T2<span class="token punctuation">,</span> T3<span class="token punctuation">,</span> T4<span class="token punctuation">,</span> T5<span class="token punctuation">,</span> T6<span class="token punctuation">,</span> T7<span class="token punctuation">,</span> TRest<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    T1 Item1 <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    T2 Item2 <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    T3 Item3 <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    T4 Item4 <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    T5 Item5 <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    T6 Item6 <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    T7 Item7 <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    TRest Rest <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token comment">/* ... */</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="generic-constraints">2.29 Generic constraints</h3>
<p>Umożliwianie przekazania dowolnego typu do generycznej klasy lub metody z reguły jest mało przydatne. Można jednak nałożyć ograniczenia na typ generyczny - kazać mu implementować jakieś interfejsy lub dziedziczyć po konkretnej klasie.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IDuck</span>
<span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">Squeak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ISqueakTracker</span>
<span class="token punctuation">{</span>
   <span class="token keyword">int</span> TimesSqueaked <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Duck</span> <span class="token punctuation">:</span> IDuck<span class="token punctuation">,</span> ISqueakTracker
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> TimesSqueaked <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">protected</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">Squeak</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Squeak!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">++</span>TimesSqueaked<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token generic-method function">SqueakIfNew<span class="token punctuation">&lt;</span>TDuck<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>TDuck duck<span class="token punctuation">)</span> 
    <span class="token keyword">where</span> TDuck <span class="token punctuation">:</span> IDuck<span class="token punctuation">,</span> ISqueakTracker
<span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>duck<span class="token punctuation">.</span>TimesSqueaked <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment">// ISqueakTracker</span>
    <span class="token punctuation">{</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"No squeaking for you!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    duck<span class="token punctuation">.</span><span class="token function">Squeak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// IDuck</span>
<span class="token punctuation">}</span>

<span class="token function">SqueakIfNew</span><span class="token punctuation">(</span>duck<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">SqueakIfNew</span><span class="token punctuation">(</span>duck<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre><code>&gt; Squeak!
&gt; No squeaking for you!
</code></pre>
<p>Istnieją też inne, specjalne ograniczenia:</p>
<ul>
<li><code>where T : class</code> - <code>T</code> musi być typem referencyjnym;</li>
<li><code>where T : struct</code> - <code>T</code> musi być value typem;</li>
<li><code>where T : new()</code> - <code>T</code> musi mieć dostępny, bezparametrowy ctor</li>
</ul>
<p>Jeśli nadajemy ograniczenia na dwa typy to piszemy drugie <code>where</code>.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">A</span><span class="token operator">&lt;</span>T<span class="token punctuation">,</span> U<span class="token operator">&gt;</span> <span class="token keyword">where</span> T <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                     <span class="token keyword">where</span> U <span class="token punctuation">:</span> T
<span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Słyszałem, że w jakimś głupim języku jest takie dziwne ograniczenie, że nie można zrobić tablicy typu generycznego.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token generic-method function">LaughsInCSharp<span class="token punctuation">&lt;</span>TeeHeeHee<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TeeHeeHee</span><span class="token punctuation">[</span><span class="token number">42</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Dodatkowo, jeśli się nie mylę, to stworzenie generyka od typu <code>int</code> jest niemożliwe w Javie i trzeba robić boxing. Oczywiście C# nie jest tak skrajnie upośledzony i parametrem generycznym może być dowolny typ. Nie jest jednak tak fajny jak C++ i nie pozwala, żeby to była np. stała.</p>
<h3 id="nullablet">2.30 <code>Nullable&lt;T&gt;</code></h3>
<p>Value types nie mogą być nullem, ale czasem może być to potrzebne. Z tego powodu istnieje wrapper class <code>Nullable&lt;T&gt;</code>, który można też wywołać lukrem syntaktycznym <code>T?</code>.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Nullable</span><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token keyword">where</span> T <span class="token punctuation">:</span> <span class="token keyword">struct</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">bool</span> hasValue<span class="token punctuation">;</span>
    <span class="token keyword">internal</span> T <span class="token keyword">value</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* ... */</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-csharp"><code class="prism  language-csharp">Nullable<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> i <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
i <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
</code></pre>
<p>To to samo co</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">int</span><span class="token operator">?</span> i <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
i <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
</code></pre>
<p><code>Nullable&lt;T&gt;</code> boxuje!</p>
<h3 id="kolekcje">2.31 Kolekcje</h3>
<p>.NET udostępnia generyczne kolekcje i interfejsy w <code>System.Collections.Generic</code>.</p>
<p><strong>Intefejsy</strong>:</p>
<ul>
<li><code>IEnumerable&lt;T&gt;</code> - cokolwiek, po czym można się przeiterować, korzysta z tego <code>foreach</code>;</li>
<li><code>ICollection&lt;T&gt;</code> - dziedziczy po <code>IEnumerable&lt;T&gt;</code>, udostępnia operacje <code>Add(T)</code>, <code>Remove(T)</code>, <code>Contains(T)</code> i property <code>Count</code>;</li>
<li><code>IList&lt;T&gt;</code> - dziedziczy po <code>ICollection&lt;T&gt;</code>, udostępnia indeksator <code>[]</code>;</li>
<li><code>IDictionary&lt;TKey, TValue&gt;</code> - dziedziczy po <code>ICollection&lt;KeyValuePair&lt;TKey, TValue&gt;&gt;</code>,  udostępnia dodawanie par klucz-wartość i odwoływanie się po kluczu przez indeksator.</li>
</ul>
<p><strong>Klasy</strong>:</p>
<ul>
<li><code>List&lt;T&gt;</code> - implementuje <code>IList&lt;T&gt;</code>, rozszerzalna tablica tak jak <code>std::vector&lt;T&gt;</code> z C++;</li>
<li><code>Dictionary&lt;TKey, TValue&gt;</code> - implementuje <code>IDictionary&lt;TKey, TValue&gt;</code>, hashmapa;</li>
<li><code>Stack&lt;T&gt;</code> - stos;</li>
<li><code>Queue&lt;T&gt;</code> - kolejka FIFO;</li>
<li><code>LinkedList&lt;T&gt;</code> - lista dwukierunkowa;</li>
<li><code>HashSet&lt;T&gt;</code> - zgaduj-zgadula;</li>
<li><code>SortedDictionary&lt;TKey, TValue</code>, <code>SortedSet&lt;T&gt;</code> - odpowiedniki <code>Dictionary</code> i <code>HashSet</code> na drzewach BST;</li>
<li><code>SortedList&lt;TKey, TValue&gt;</code> - posortowana lista (taka ze wstawianiem w <span class="katex--inline"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="script">O</mi><mo>(</mo><mi>n</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathcal" style="margin-right: 0.02778em;">O</span></span><span class="mopen">(</span><span class="mord mathit">n</span><span class="mclose">)</span></span></span></span></span>)</li>
<li><code>Lookup&lt;TKey, TValue&gt;</code> - słownik, ale do każdego klucza może być wiele wartości</li>
</ul>
<p>Lista jest najpowszechniejszą z kolekcji. Do iterowania się po kolekcjach w <span class="katex--inline"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>90</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">90\%</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.80556em; vertical-align: -0.05556em;"></span><span class="mord">9</span><span class="mord">0</span><span class="mord">%</span></span></span></span></span> przypadków używamy <code>foreacha</code>. Do inicjalizowania kolekcji wygodnie użyć…  no cóż, inicjalizatora kolekcji.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">var</span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">7</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token keyword">var</span> num <span class="token keyword">in</span> list<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Console<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre><code>&gt; 2137
</code></pre>
<h3 id="ko--i-kontrawariancja">2.32 Ko- i kontrawariancja</h3>
<p>Intuicja:</p>
<ul>
<li>Kowariancja jest wtedy, kiedy nic nie wkładamy, ale wyciągamy.</li>
<li>Kontrawariancja jest wtedy, kiedy wkładamy, ale nie wyciągamy.</li>
</ul>
<pre class=" language-csharp"><code class="prism  language-csharp">IEnumerable<span class="token operator">&lt;</span>Duck<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token operator">&lt;</span>BetterDuck<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Nasze interfejsy mogą być ko- lub kontrawariantne dzięki keywordom <code>out</code> i <code>in</code>.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IDuckGenerator</span><span class="token operator">&lt;</span><span class="token keyword">out</span> TDuck<span class="token operator">&gt;</span> <span class="token keyword">where</span> TDuck <span class="token punctuation">:</span> Duck
<span class="token punctuation">{</span>
    TDuck <span class="token function">Generate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IDuckSqueaker</span><span class="token operator">&lt;</span><span class="token keyword">in</span> TDuck<span class="token operator">&gt;</span> <span class="token keyword">where</span> TDuck <span class="token punctuation">:</span> IDuck
<span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">Squeak</span><span class="token punctuation">(</span>TDuck<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* DuckGenerator and DuckSqueaker implementations... */</span>

<span class="token comment">// Covariance.</span>
IDuckGenerator<span class="token operator">&lt;</span>Duck<span class="token operator">&gt;</span> duckGenerator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DuckGenerator</span><span class="token operator">&lt;</span>BetterDuck<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Contravariance.</span>
IDuckSqueaker<span class="token operator">&lt;</span>BetterDuck<span class="token operator">&gt;</span> duckSqueaker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DuckSqueaker</span><span class="token operator">&lt;</span>Duck<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="stringi">2.33 Stringi</h3>
<p>Wspomnieliśmy już, że porównywanie zmiennych typu <code>string</code> za pomocą <code>==</code> jest intuicyjne. Należy pamiętać także o bardzo ważnej rzeczy - stringi są immutable. To znaczy, że wywołanie:</p>
<pre><code>var str = "Hello";
str += " World!";
</code></pre>
<p>spowoduje stworzenie zupełnie nowego stringa <code>"Hello World!"</code> i przypisanie go do zmiennej <code>str</code>. Więc gdyby chcieć np. stworzyć z ciągu zer i jedynek napis składający się z liter <code>a</code> i <code>b</code> w taki sposób:</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">string</span> <span class="token function">ToABString</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> sequence<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
    
    <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token keyword">var</span> element <span class="token keyword">in</span> sequence<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        result <span class="token operator">+</span><span class="token operator">=</span> <span class="token punctuation">(</span>element <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token string">"a"</span> <span class="token punctuation">:</span> <span class="token string">"b"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>to złożoność czasowa i pamięciowa wyniesie <span class="katex--inline"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="script">O</mi><mo>(</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathcal" style="margin-right: 0.02778em;">O</span></span><span class="mopen">(</span></span></span></span></span><code>sequence.Length</code><span class="katex--inline"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mrow></mrow><mn>2</mn></msup><mo>)</mo></mrow><annotation encoding="application/x-tex">^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1.06411em; vertical-align: -0.25em;"></span><span class="mord"><span class=""></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>. Do takich operacji służy klasa <code>StringBuilder</code> (.NET Standard).</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">string</span> <span class="token function">ToABString</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> sequence<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">var</span> stringBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token keyword">var</span> element <span class="token keyword">in</span> sequence<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        stringBuilder<span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span>element <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token string">'a'</span> <span class="token punctuation">:</span> <span class="token string">'b'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> stringBuilder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Stringi też występują w różnych smakach. Mamy zwykłe, interpolowane i verbatim.</p>
<ul>
<li><strong>Interpolated string</strong> - pozwala na wplecenie wartości zmiennych do literału</li>
</ul>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Duck</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> 
    <span class="token keyword">public</span> <span class="token keyword">int</span> TimesSqueaked <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">Duck</span><span class="token punctuation">(</span><span class="token keyword">string</span> name<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Squeak</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token operator">++</span>TimesSqueaked<span class="token punctuation">;</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"Duck {Name}: Squeak! [Squeak #{TimesSqueaked}]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Jest to “mniej więcej równoważne” napisaniu</p>
<pre class=" language-csharp"><code class="prism  language-csharp">Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Duck "</span> <span class="token operator">+</span> Name <span class="token operator">+</span> <span class="token string">": Squeak! [Squeak #"</span> <span class="token operator">+</span> TimesSqueaked <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>A dla ścisłości jest dokładnie równoważne</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"Duck {0}: Squeak! [Squeak #{1}]"</span><span class="token punctuation">,</span> Name<span class="token punctuation">,</span> TimesSqueaked<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<ul>
<li><strong>Verbatim string</strong> - pozwala na dosłowne interpretowanie stringa</li>
</ul>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">var</span> str <span class="token operator">=</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> verbatimStr <span class="token operator">=</span> <span class="token string">@"\n"</span><span class="token punctuation">;</span>

Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>verbatimStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre><code>&gt; 
&gt; 
&gt; \n
</code></pre>
<p>Można te typy łączyć ze sobą</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">var</span> duck <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Duck</span><span class="token punctuation">(</span><span class="token string">"Jacuś"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> mix <span class="token operator">=</span> $<span class="token string">@"{duck.Name}\n"</span><span class="token punctuation">;</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>mix<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre><code>&gt; Jacuś\n
</code></pre>
<h3 id="więcej-o-verbatim">2.34 Więcej o verbatim</h3>
<p>Jak już przy tym jesteśmy, znaczka <code>@</code> można użyć też do escape’owania keywordów.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token comment">// object object = new object() // Does not compile.</span>
<span class="token keyword">object</span> @<span class="token keyword">object</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// This is correct.</span>
</code></pre>
<h3 id="statyczne-klasy">2.35 Statyczne klasy</h3>
<p>Czasami metody albo stałe nie należą do żadnej konkretnej instancji, ale są ogólną własnością klasy. Deklarujemy je wtedy jako <code>static</code>. Często jednak zdarza się, że mamy wiele pomocniczych metod, które nijak nie są związane z konkretnym obiektem (np. klasa <code>Math</code>). Wtedy taką klasę można zadeklarować jako statyczną. Nie może mieć ona ctora  i nie da się stworzyć jej instancji. Wszystkie jej składowe też muszą być statyczne.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Math</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">const</span> <span class="token keyword">double</span> E <span class="token operator">=</span> <span class="token number">2.7182818284590452354</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">const</span> <span class="token keyword">double</span> PI <span class="token operator">=</span> <span class="token number">3.14159265358979323846</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">Max</span><span class="token punctuation">(</span><span class="token keyword">int</span> val1<span class="token punctuation">,</span> <span class="token keyword">int</span> val2<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>val1 <span class="token operator">&gt;=</span> val2<span class="token punctuation">)</span> <span class="token operator">?</span> val1 <span class="token punctuation">:</span> val2<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="extension-methods">2.36 Extension methods</h3>
<p>Bardzo ciekawym mechanizmem jak na statycznie typowany język są extension methods. Jest to co prawda jedynie lukier syntaktyczny, ale pozwala nam wywoływać metody na obiektach danego typu jakby były ich memberami.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">DuckExtensions</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">SqueakNTimes</span><span class="token punctuation">(</span><span class="token keyword">this</span> Duck duck<span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            duck<span class="token punctuation">.</span><span class="token function">Squeak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> duck <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Duck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

duck<span class="token punctuation">.</span><span class="token function">SqueakNTimes</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre><code>&gt; Squeak!
&gt; Squeak!
&gt; Squeak!
</code></pre>
<p>Nie można jednak w ten sposób obejść access specifierów - widzimy tylko publiczne rzeczy (ewentualnie <code>internal</code>).</p>
<h3 id="operatory">2.37 Operatory</h3>
<p>W C# mamy standardowe operatory jak w C lub C++. Przydatną informacją jest to, że operatory <code>||</code> oraz <code>&amp;&amp;</code> są leniwe (defacto są zaimplementowane za pomocą <code>|</code> i <code>&amp;</code>). W przypadku <code>bool?</code> zachowanie tych operatorów jest takie jak w SQL-u (stety/niestety).</p>
<p>C# ma też tzw. null-coalescing operator `??</p>
<pre class=" language-csharp"><code class="prism  language-csharp">a <span class="token operator">?</span><span class="token operator">?</span> b<span class="token punctuation">;</span>
</code></pre>
<p>jest równoważne</p>
<pre class=" language-csharp"><code class="prism  language-csharp">a <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> a <span class="token punctuation">:</span> b<span class="token punctuation">;</span>
</code></pre>
<p>Oraz operator <code>?.</code></p>
<pre class=" language-charp"><code class="prism  language-charp">a?.Property;
</code></pre>
<p>jest równoważne</p>
<pre class=" language-csharp"><code class="prism  language-csharp">a <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> a<span class="token punctuation">.</span>Property <span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="przeciążanie-operatorów">2.38 Przeciążanie operatorów</h3>
<p>Tak, można! Nie można tylko przypisania i <code>||</code>/<code>&amp;&amp;</code> (ale można <code>|</code>/<code>&amp;</code>). Można nawet przeciążyć <code>==</code>, choć jest to niezalecane. Przypisania być przeciążane parami.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Duck</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>\

    <span class="token keyword">public</span> <span class="token function">Duck</span><span class="token punctuation">(</span><span class="token keyword">string</span> name<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">bool</span> <span class="token keyword">operator</span> <span class="token operator">==</span><span class="token punctuation">(</span>Duck duck1<span class="token punctuation">,</span> Duck duck2<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> duck1<span class="token operator">?</span><span class="token punctuation">.</span>Name <span class="token operator">==</span> duck2<span class="token operator">?</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">bool</span> <span class="token keyword">operator</span> <span class="token operator">!=</span><span class="token punctuation">(</span>Duck duck1<span class="token punctuation">,</span> Duck duck2<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token operator">!</span><span class="token punctuation">(</span>duck1 <span class="token operator">==</span> duck2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> duck <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Duck</span><span class="token punctuation">(</span><span class="token string">"Jacuś"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> otherDuck <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Duck</span><span class="token punctuation">(</span><span class="token string">"Jacuś"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>duck <span class="token operator">==</span> otherDuck<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre><code>&gt; True
</code></pre>
<h3 id="indekser">2.39 Indekser</h3>
<p>Nasz typ może definiować swój indekser, tj. zachowanie dla operatora <code>[]</code>.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyTableWrapper</span><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> T<span class="token punctuation">[</span><span class="token punctuation">]</span> _tab<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">MyTableWrapper</span><span class="token punctuation">(</span><span class="token keyword">int</span> length<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _tab <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">T</span><span class="token punctuation">[</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> T <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token keyword">int</span> i<span class="token punctuation">]</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">get</span> <span class="token operator">=</span><span class="token operator">&gt;</span> _tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">set</span> <span class="token operator">=</span><span class="token operator">&gt;</span> _tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">value</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="custom-cast">2.40 Custom cast</h3>
<p>Można zdefiniować swoje własne jawne i niejawne castowanie za pomocą <code>implicit</code> i <code>explicit</code>.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">A</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">implicit</span> <span class="token keyword">operator</span> <span class="token function">B</span><span class="token punctuation">(</span>A a<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">/* ... */</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">B</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">explicit</span> <span class="token keyword">operator</span> <span class="token function">A</span><span class="token punctuation">(</span>B b<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">/* ... */</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
A a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
B b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">B</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

A bAsA <span class="token operator">=</span> <span class="token punctuation">(</span>A<span class="token punctuation">)</span>b<span class="token punctuation">;</span>
B aAsB <span class="token operator">=</span> a<span class="token punctuation">;</span>
</code></pre>
<h3 id="tuples-valuetuple">2.41 Tuples (ValueTuple)</h3>
<p>Wspomnieliśmy wcześniej o Tuple’ach, jednak w C# 7 używa się ValueTuples. Pozwalają one na nazwanie pól:</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">var</span> myPoint <span class="token operator">=</span> <span class="token punctuation">(</span>x<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>myPoint<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>myPoint<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre><code>&gt; 4
&gt; 2
</code></pre>
<p>Takie tuple można też dekonstruować w miejscu:</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">var</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token operator">=</span> myPoint<span class="token punctuation">;</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre><code>&gt; 4
&gt; 2
</code></pre>
<p>ValueTuple to struct.</p>
<h3 id="wyjątki">2.42 Wyjątki</h3>
<p>Wyjątki rzuca się <code>throw</code>, każdy wyjątek musi dziedziczyć po <code>System.Exception</code>. Wyjątki łapie się konstrukcją <code>try</code>/<code>catch</code> i można je zrethrowować.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">try</span>
<span class="token punctuation">{</span>
    <span class="token comment">/* ... */</span>
<span class="token punctuation">}</span>
<span class="token keyword">catch</span><span class="token punctuation">(</span>InvalidOperationException exception<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>exception<span class="token punctuation">.</span>Message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">throw</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Jeśli nie obchodzi nas jaki wyjątek łapiemy (rzadko), piszemy:</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">try</span>
<span class="token punctuation">{</span>
    <span class="token comment">/* ... */</span>
<span class="token punctuation">}</span>
<span class="token keyword">catch</span>
<span class="token punctuation">{</span>
   <span class="token comment">/* ... */</span>
<span class="token punctuation">}</span>
</code></pre>
<p>jeśli nie potrzebujemy obiektu wyjątku, możemy napisać</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">try</span>
<span class="token punctuation">{</span>
    <span class="token comment">/* ... */</span>
<span class="token punctuation">}</span>
<span class="token keyword">catch</span><span class="token punctuation">(</span>InvalidOperationException<span class="token punctuation">)</span> <span class="token comment">// Without declaring a variable.</span>
<span class="token punctuation">{</span>
    <span class="token comment">/* ... */</span>
<span class="token punctuation">}</span>
</code></pre>
<p>C# ma też konstrukcję <code>finally</code>. Kod w bloku <code>finally</code> wywołuje się zawsze, nawet w przypadku wyjątku. Może wystąpić bez <code>catcha</code>. Ta konstrukcja mogłaby się przydawać np. do wywoływania <code>Dispose</code>, gdyby nie <code>using</code>.</p>
<h3 id="garbage-collector">2.43 Garbage collector</h3>
<p>Nie będziemy wchodzić w szczegóły GC. Najważniejsze informacje to:</p>
<ul>
<li>Wszystkie obiekty na stercie, do których nie istnieje ścieżka w grafie obiektów są niekatywne.</li>
<li>GC od czasu do czasu przechodzi się po stercie i usuwa nieaktywne obiekty. Cały proces jest skomplikowany i bierze w nim udział wiele enzymów. Sterta jest defragmentowana, obiekty są podzielone na 3 generacje, yada yada.</li>
<li>Value types są <strong>zazwyczaj</strong> alokowane na stosie. Wyjątki to między innymi pola klas i rzeczy złapane przez delegaty.</li>
</ul>
<p>W związku z tym, że obiekty mogą trochę poczekać zanim zostaną zniszczone, nawet jak już są niepotrzebne, powstał Dispose pattern.</p>
<h3 id="dispose">2.44 Dispose</h3>
<p>Jeśli klasa trzyma jakiś managed resource, który jest “ciężki”, np. file handle, połączenie z bazą danych itp., powinien implementować <code>IDisposable</code>. Interfejs ten zawiera jedną metodę <code>void Dispose()</code>, która ma zwolnić zasoby. Kanoniczna implementacja dispose pattern bez finalize wygląda tak:</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Repository</span> <span class="token punctuation">:</span> IDisposable
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">bool</span> _disposed <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> DbConnection _connection<span class="token punctuation">;</span>	<span class="token comment">// Managed, disposable resource.</span>
	
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
	    <span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    GC<span class="token punctuation">.</span><span class="token function">SuppressFinalize</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">protected</span> <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token keyword">bool</span> disposing<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span>_disposed<span class="token punctuation">)</span>
         <span class="token punctuation">{</span>
             <span class="token keyword">return</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>

         <span class="token keyword">if</span><span class="token punctuation">(</span>disposing<span class="token punctuation">)</span>
         <span class="token punctuation">{</span>
             _connection<span class="token punctuation">.</span><span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>

         _disposed <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Wspomnieliśmy wcześniej o bloku <code>finalize</code>. Jest jednak o wiele przyjemniejszy syntax sugar w postaci dyrektywy <code>using</code>.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">DoStuffWithRepo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">using</span><span class="token punctuation">(</span><span class="token keyword">var</span> repo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Repository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        repo<span class="token punctuation">.</span><span class="token function">DoStuff</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>jest równoważne</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">DoStuffWithRepo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">var</span> repo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Repository</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    repo<span class="token punctuation">.</span><span class="token function">DoStuff</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    repo<span class="token punctuation">.</span><span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Można tę dyrektywę stackować:</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">DoStuffWithRepo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">using</span><span class="token punctuation">(</span><span class="token keyword">var</span> repo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Repository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">using</span><span class="token punctuation">(</span><span class="token keyword">var</span> someOtherDisposable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SomeOther</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">using</span><span class="token punctuation">(</span><span class="token keyword">var</span> moreDisposables <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SomeOther</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        repo<span class="token punctuation">.</span><span class="token function">DoStuff</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/* ... */</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="finalize">2.45 Finalize</h3>
<p>Finalize/destruktor służy do zwalniania <em>unmanaged</em> resources. Takie zasoby też powinny być zwalniane przez <code>Dispose</code>, ale finalizer służy jako safeguard, gdyby wywołanie <code>Dispose</code> zawiodło albo jakiś JavaScript-Ninja o nim zapomniał. Zawsze implementujemy <code>Dispose</code> pattern, a potem dodajemy:</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token operator">~</span>MyClass
<span class="token punctuation">{</span>
    <span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token keyword">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Po pierwsze - jeśli kiedykolwiek trzeba pracować z unmanaged resources to i tak będzie trzeba przeczytać MSDN-a jeszcze raz.<br>
Po drugie - Finalize should be a last resort, specialize <code>SafeHandle</code> instead.</p>
<h3 id="atrybuty">2.46 Atrybuty</h3>
<p>Atrybuty zawierają metadane. Same z siebie nie za wiele robią, ale można się do nich dostać przez refleksję i wyłuskać dane (będziemy ich bardzo używać przy ASP i EF). Każdy atrybut ma nazwę kończącą się na <code>Attribute</code> i dziedziczy po <code>Attribute</code>.<br>
Przykładowo atrybut <code>ObsoleteAttribute</code>, używany przez kompilator do nakrzyczenia na użytkownika danej metody:</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyClass</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">[</span>Obsolete<span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">MyMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">/* ... */</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Jeśli konstruktor atrybutu przyjmuje jakieś argumenty, to podajemy je w tagu.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyClass</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token function">Obsolete</span><span class="token punctuation">(</span><span class="token string">"This method is deprecated because of reasons, don't use it"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">MyMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">/* ... */</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Przy tworzeniu własnych atrybutów trzeba podać przy deklaracji do jakich pól będzie stosowany.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token punctuation">[</span><span class="token function">AttributeUsage</span><span class="token punctuation">(</span>AttributeTargets<span class="token punctuation">.</span>Class <span class="token operator">|</span> AttributeTargets<span class="token punctuation">.</span>Struct<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyAttribute</span> <span class="token punctuation">:</span> Attribute
<span class="token punctuation">{</span>
    <span class="token comment">/* ... */</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="nameof">2.47 <code>nameof</code></h3>
<p>Taki mały feature, <code>nameof</code> zostaje statycznie zamienione na nazwę zmiennej/pola/metody etc.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">var</span> duck <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Duck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"{nameof(duck.Squeak)}!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre><code>&gt; Squeak!
</code></pre>
<h3 id="delegates">2.48 Delegates</h3>
<p>Delegaty to type-safe function references. Najpierw trzeba zadeklarować sam typ:</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">delegate</span> <span class="token keyword">int</span> <span class="token function">BinaryOperator</span><span class="token punctuation">(</span><span class="token keyword">int</span> lhs<span class="token punctuation">,</span> <span class="token keyword">int</span> rhs<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Może on być składową jakiejś klasy albo być luzem w namespace’ie. Następnie możemy przypisać do zmiennej tego typu jakąś metodę i ją wywołać.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">Plus</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>

BinaryOperator binaryOperator <span class="token operator">=</span> Plus<span class="token punctuation">;</span>

Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token function">binaryOperator</span><span class="token punctuation">(</span><span class="token number">17</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre><code>&gt; 42
</code></pre>
<p>Delegaty są w rzeczywistości jeszcze potężniejsze, można do jednej takiej zmiennej przypisać wiele metod, które zostaną wykonane kolejno z tymi samymi argumentami. Delegat zwróci wartość z ostatniej wywołanej metody.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">Plus</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"{a} + {b} = {a + b}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">Minus</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"{a} - {b} = {a - b}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> a <span class="token operator">-</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

BinaryOperator binaryOperators <span class="token operator">=</span> Plus<span class="token punctuation">;</span>
binaryOperators <span class="token operator">+</span><span class="token operator">=</span> Minus<span class="token punctuation">;</span>

Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token function">binaryOperators</span><span class="token punctuation">(</span><span class="token number">17</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre><code>&gt; 17 + 25 = 42  
&gt; 17 - 25 = -8  
&gt; -8
</code></pre>
<p>Po metodach zawartych w delagacie można się przeiterować:</p>
<pre class=" language-csharp"><code class="prism  language-csharp">BinaryOperator binaryOperators <span class="token operator">=</span> Plus<span class="token punctuation">;</span>
binaryOperators <span class="token operator">+</span><span class="token operator">=</span> Minus<span class="token punctuation">;</span>

<span class="token keyword">foreach</span><span class="token punctuation">(</span>BinaryOperator func <span class="token keyword">in</span> binaryOperators<span class="token punctuation">.</span><span class="token function">GetInvocationList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token function">func</span><span class="token punctuation">(</span><span class="token number">17</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<pre><code>&gt; 17 + 25 = 42  
&gt; 42  
&gt; 17 - 25 = -8  
&gt; -8
</code></pre>
<p>.NET udostępnia dwa fundamentalne, generyczne typy delagatów:</p>
<ul>
<li><code>Action&lt;T1, T2, ..., TN&gt;</code> - metoda niezwracająca żadnej wartości, przyjmująca N argumentów typów kolejno <code>T1</code>, <code>T2</code>, …, <code>TN</code>;</li>
<li><code>Func&lt;T1, T2, ..., TN, TResult&gt;</code> - metoda zwracająca <code>TResult</code> i przyjmująca N argumentów  typów kolejno <code>T1</code>, <code>T2</code>, …, <code>TN</code>;</li>
</ul>
<p>Jeśli przypiszemy do delegata instance method, to delegat złapie tę konkretną instancję i <code>this</code> w ciele przypisanej metody będzie się do niej odwoływać.</p>
<p>Typy delegatów są kowariantne ze względu na typ zwracany i kontrawariantne ze względu na typy przyjmowane.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> Derived <span class="token function">Foo</span><span class="token punctuation">(</span>Base b1<span class="token punctuation">,</span> Base b2<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Derived</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

Func<span class="token operator">&lt;</span>Derived<span class="token punctuation">,</span> Derived<span class="token punctuation">,</span> Base<span class="token operator">&gt;</span> func1 <span class="token operator">=</span> Foo<span class="token punctuation">;</span> <span class="token comment">// Legal assignment.</span>
</code></pre>
<p><strong>Uwaga:</strong> Typy delegatów są ze sobą zupełnie niezgodne (poza wspomnianą ko- / kontrawariancją). Np. takie przypisanie:</p>
<pre class=" language-csharp"><code class="prism  language-csharp">BinaryOperator binaryOperator <span class="token operator">=</span> Plus<span class="token punctuation">;</span>
Func<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">&gt;</span> f <span class="token operator">=</span> binaryOperator<span class="token punctuation">;</span>
</code></pre>
<p>jest nielegalne. Z tego też powodu nie można używać <code>var</code> przy deklaracjach obiektów delegatów.</p>
<h3 id="lambdy">2.49 Lambdy</h3>
<p>Bardzo często do delegatów przypisujemy krótkie wyrażenia i nie ma sensu tworzyć dla nich dedykowanych metod. I tu wchodzą lambdy, całe na biało.</p>
<pre class=" language-csharp"><code class="prism  language-csharp">BinaryOperator binaryOperator <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>
</code></pre>
<p>Typy po prawej mogą zostać wydedukowane przez kompilator.</p>
<pre class=" language-csharp"><code class="prism  language-csharp">BinaryOperator binaryOperator <span class="token operator">=</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>
</code></pre>
<p>Jakie ograniczenia mają lambdy względem zwykłych metod? Praktycznie żadnych, poza małą rzeczą związaną z <code>dynamic</code>. Mogą mieć pełnoprawne ciała:</p>
<pre class=" language-csharp"><code class="prism  language-csharp">BinaryOperator binaryOperator <span class="token operator">=</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Lambdas are awesome!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token function">binaryOperator</span><span class="token punctuation">(</span><span class="token number">17</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre><code>&gt; Lambdas are awesome!
&gt; 42
</code></pre>
<p>Argumenty lambd mogą być <code>ref</code> i <code>out</code>.<br>
Lambdy mogą nie mieć argumentów</p>
<pre class=" language-csharp"><code class="prism  language-csharp">Func<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> f <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">42</span><span class="token punctuation">;</span>
</code></pre>
<p>mogą  nic nie zwracać</p>
<pre class=" language-csharp"><code class="prism  language-csharp">Action<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> f <span class="token operator">=</span> x <span class="token operator">=</span><span class="token operator">&gt;</span> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>mogą nic nie przyjmować i nic nie zwracać</p>
<pre class=" language-csharp"><code class="prism  language-csharp">Action f <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>No i lambdy są kompatybilne z dowolnym delegatem o odpowiedniej sygnaturze.</p>
<pre class=" language-csharp"><code class="prism  language-csharp">BinaryOperator bin <span class="token operator">=</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>
Func<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">&gt;</span> fun <span class="token operator">=</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>
</code></pre>
<h3 id="lazyt">2.50 <code>Lazy&lt;T&gt;</code></h3>
<p>Wspomnieliśmy, że konwencjonalnie properties powinny nie być resource-intensive. Czasami jednak chcemy mieć propertę, której inicjalizacja zajmuje dużo czasu, bo np. reprezentuje bardzo duży obiekt. W takim wypadku możemy użyć klasy <code>Lazy&lt;T&gt;</code>. Przyjmuje ona inicjalizator i wykonuje go przy pierwszym odwołaniu do property <code>Value</code>. Każde kolejne odwołanie spowoduje zwrócenie raz utworzonego obiektu. Implementuje to schemat lazy initialization - obiekt jest tworzony dopiero wtedy, kiedy jest potrzebny, ale tylko raz.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GiantDuck</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token comment">/* A lot of members */</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GiantDuckContainer</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> Lazy<span class="token operator">&lt;</span>GiantDuck<span class="token operator">&gt;</span> Duck <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> GiantDuckContainer
    <span class="token punctuation">{</span>
        Duck <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Lazy</span><span class="token operator">&lt;</span>GiantDuck<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">new</span> <span class="token class-name">GiantDuck</span><span class="token punctuation">(</span><span class="token string">"Jacuś"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Uważny słuchacz powinien się teraz spytać, jak będzie to działać, jeśli kilka wątków odwoła się do <code>Value</code> jednocześnie. Domyślnie działa to sensownie - jest thread safe. Można to explicitly wyłączyć używając innego konstruktora <code>Lazy&lt;T&gt;</code>, który przyjmuje <code>bool isThreadSafe</code>. Powinno się tego używać tylko wtedy, kiedy wydajność jest szczególnie ważna, przy zachowaniu szczególnej ostrożności i włączonym kierunkowskazie.<br>
Jeśli chcemy tworzyć obiekt za pomocą domyślnego konstruktora, to możemy pominąć inicjalizującą lambdę, tzn.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">new</span> <span class="token class-name">Lazy</span><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// Thread safe.</span>
<span class="token keyword">new</span> <span class="token class-name">Lazy</span><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Non-thread safe.</span>
</code></pre>
<p>są równoważne</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">new</span> <span class="token class-name">Lazy</span><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">new</span> <span class="token class-name">T</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// Thread safe.</span>
<span class="token keyword">new</span> <span class="token class-name">Lazy</span><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">new</span> <span class="token class-name">T</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Thread safe.</span>
</code></pre>
<p>Dodatkowo, jeśli <em>niestandardowa</em> inicjalizacja wyrzuci wyjątek, to każde kolejne odwołanie do tego samego <code>Value</code> wyrzuci ten sam wyjątek.</p>
<h3 id="lokalne-metody">2.51 Lokalne metody</h3>
<p>Czasami chcemy mieć metodę, którą wywołamy kilkukrotnie w czasie wywoływania naszej logiki. Nie chcemy powtarzać kodu, ale nie chcemy też tworzyć pomocniczej metody używanej tylko w jednym miejscu i nie mającej wartości poza tym konkretnym miejscem. Można by utworzyć delegata do tej metody, ale jest to niepotrzebne alokowanie pamięci i wywołanie metody potrwa trochę dłużej. Lepiej użyć lokalnej metody:</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">CalculateStuff</span><span class="token punctuation">(</span><span class="token keyword">params</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">]</span> vals<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">var</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> <span class="token function">Plus</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token function">Minus</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> a <span class="token operator">-</span> b<span class="token punctuation">;</span>

    <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token keyword">var</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token keyword">in</span> vals<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        sum <span class="token operator">+</span><span class="token operator">=</span> <span class="token function">Plus</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">Minus</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> sum <span class="token operator">/</span> vals<span class="token punctuation">.</span>Length<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token function">CalculateStuff</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">17</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">35</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre><code>&gt; 42
</code></pre>
<h3 id="to-już-jest-prawie-koniec">2.52 To już jest (prawie) koniec</h3>
<p>Zostało nam programowanie asynchroniczne i LINQ, ale o tym w następnych działach.</p>
<h2 id="yyy-na-mimie-nie-uczą-o-solid1">3. “Yyy, na MIMie nie uczą o SOLID!!!1”</h2>
<p>SOLID principles:</p>
<ul>
<li><strong>S</strong>ingle responsibility - każda klasa powinna mieć dokładnie jedną, ściśle zdefiniowaną odpowiedzialność.</li>
<li><strong>O</strong>pen-closed - klasy powinny być otwarte na rozszerzanie, ale zamknięte na modyfikacje.</li>
<li><strong>L</strong>iskov substitution principle - święta zasada projektowania hierarchii dziedziczenia - jeśli typ B dziedziczy po A, to B <em>jest</em> A.</li>
<li><strong>I</strong>nterface segregation - interfejsy powinny być najmniejsze możliwe, w szczególności użytkownik nie powinien nic wiedzieć o metodach, których nie potrzebuje.</li>
<li><strong>D</strong>ependency inversion - depend on abstractions, not concretions.</li>
</ul>
<p>No to już uczą. Szczególną uwagę poświęcimy literce <strong>D</strong>.</p>
<h3 id="inversion-of-control">3.1 Inversion of Control</h3>
<p>Inversion of Control jest sposobem na spełnienie SOLID-owego <strong>D</strong>. Załóżmy, że nasz kod chce wyciągnąć coś z bazy danych. Ma do tego repozytorium:</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Duck</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> Color Color <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IRepository</span>
<span class="token punctuation">{</span>
    Duck <span class="token function">GetDuckByName</span><span class="token punctuation">(</span><span class="token keyword">string</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Repository</span> <span class="token punctuation">:</span> IRepository<span class="token punctuation">,</span> IDisposable
<span class="token punctuation">{</span>
    <span class="token comment">/* ... */</span>
    
    <span class="token keyword">public</span> <span class="token function">Repository</span><span class="token punctuation">(</span><span class="token keyword">string</span> connectionString<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">/* ... */</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/* ... */</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Przykładowy <code>Main</code> wyglądałby jakoś tak:</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Program</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">const</span> ConnectionString <span class="token operator">=</span> <span class="token string">"UserID=posgres;Password=postgres;Host=localhost;Port=5432;Database=duck_db"</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">using</span><span class="token punctuation">(</span><span class="token keyword">var</span> repository <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Repository</span><span class="token punctuation">(</span>ConnectionString<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">var</span> duck <span class="token operator">=</span> repository<span class="token punctuation">.</span><span class="token function">GetDuckByName</span><span class="token punctuation">(</span><span class="token string">"Jacuś"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>duck <span class="token keyword">is</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">"Nie ma Jacusia :("</span> <span class="token punctuation">:</span> <span class="token string">"Jest Jacuś! :&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Mamy tutaj bardzo mocny coupling między <code>Mainem</code> a repozytorium. Jest on wręcz nietestowalny. “New is glue”, and glueing the code is bad.<br>
Tutaj <code>Main</code> ma kontrolę nad tym, jakiego repozytorium używa. Trzeba tę kontrolę <strong>odwrócić</strong> (IoC) i tę zależność od repozytorium <strong>wstrzyknąć</strong> (Dependency Injection, DI).</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Program</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Main</span><span class="token punctuation">(</span>IRepository repository<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">var</span> duck <span class="token operator">=</span> repository<span class="token punctuation">.</span><span class="token function">GetDuckByName</span><span class="token punctuation">(</span><span class="token string">"Jacuś"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>duck <span class="token keyword">is</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">"Nie ma Jacusia :("</span> <span class="token punctuation">:</span> <span class="token string">"Jest Jacuś! :&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Teraz to wywołujący <code>Maina</code> ma kontrolę nad tym, jakie repozytorium dostanie aplikacja. W szczególności może to ustawić za pomocą statycznych metadanych np. w pliku konfiguracyjnym. Teraz tę metodę można łatwo przetestować, bo możemy podać testowe repozytorium, nad którym mamy pełną kontrolę.</p>
<p>Don’t let your code get the better of you. Take control.</p>
<h3 id="ioc-container--service-locator">3.2 IoC Container / Service Locator</h3>
<p>Powyższy pattern jest bardzo powszechny. Praktycznie każdy element aplikacji ma jakieś zależności i te zależności powinny być decoupled od kodu, który ich używa, połączony jedynie ładnym interfejsem. Do osiągnięcia tego używa się kontenerów IoC. My zajmiemy się Microsoftowym <code>ServiceProviderem</code> dostępnym out-of-the-box w ASP .NET Corze.</p>
<p>Korzystając z poprzedniego przykładu użyjmy <code>IServiceProvidera</code> do ustawienia odpowiedniego repozytorium.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Startup</span>
<span class="token punctuation">{</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span>IServiceCollection services<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
	    <span class="token keyword">const</span> <span class="token keyword">string</span> connectionString <span class="token operator">=</span> <span class="token string">"UserID=posgres;Password=postgres;Host=localhost;Port=5432;Database=duck_db"</span><span class="token punctuation">;</span>    
	    services<span class="token punctuation">.</span><span class="token generic-method function">AddScoped<span class="token punctuation">&lt;</span>IRepository<span class="token punctuation">,</span> Repository<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>sp <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Repository</span><span class="token punctuation">(</span>connectionString<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Nie przejmując się tym, co znaczy <code>Scoped</code>, we’re done. Teraz automatycznie jeśli potrzebowali wstrzykniętego <code>IRepository</code>, <code>ServiceProvider</code> podczas instancjonowania odpowiedniego obiektu, który wymaga <code>IRepository</code> w konstruktorze, stworzy nowe repozytorium i je przekaże (akurat z <code>Mainem</code> to nie zadziała,  ale disregard that).</p>
<p>Każda zależność w aplikacji powinna być skonfigurowana w podobny sposób. Później jeszcze do tego wrócimy i powiemy co to <code>Scoped</code> i co robią inne modyfikatory.</p>
<h3 id="testowanie-xunit">3.3 Testowanie (XUnit)</h3>
<p>Większość rzeczy związanych z czystym kodem i elegancką architekturą ma dwa cele - po pierwsze, wprowadzenie zmiany powinno wymagać nakładu pracy mniej więcej liniowo proporcjonalnego do rozmiaru tej zmiany. Po drugie, kod musi być testowalny. Nie będziemy tutaj poruszać zagadnień Test Driven Development, ale postaramy się przynajamniej nie robić Yolo Driven Development.</p>
<p>Testowanie jest w swych założeniach banalne - chcemy wziąć interfejs danego elementu i przetestować, czy metody w tym interfejsie robią to, co powinny. Przypatrzymy się bardzo na szybko XUnitowi jako frameworkowi do testów i NSubstitute do mocków.</p>
<h4 id="założenia-unit-testów">Założenia unit-testów</h4>
<p>Unit testy powinny być:</p>
<ul>
<li>Deterministyczne - ten sam kod zawsze przechodzi lub zawsze failuje dany test.</li>
<li>Niezależne - wykonanie jednego testu nie może w żaden sposób wpłynąć na wykonanie innych</li>
<li>Zwięzłe - jeśli test jest długi, prawdopodobnie metoda jest zbyt skomplikowana</li>
<li>Odizolowane - jeden unit test powinien testować jeden unit, wszystkie zależności powinny być zmockowane</li>
</ul>
<h4 id="arrange-act-assert">Arrange, Act, Assert</h4>
<p>Standardowym workflowem do tworzenia unit testów jest AAA - Arrange, Act, Assert. Zobaczmy przykładowy test klasy <code>Calculator</code>.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CalculatorUnitTests</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">[</span>Fact<span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Square_GivenAnyInteger_ReturnsItsSquare</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// ARRANGE</span>
        <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token keyword">value</span> <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token keyword">int</span> expectedSquare <span class="token operator">=</span> <span class="token keyword">value</span> <span class="token operator">*</span> <span class="token keyword">value</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> systemUnderTest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Calculator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token comment">// ACT</span>
        <span class="token keyword">var</span> actualSquare <span class="token operator">=</span> systemUnderTest<span class="token punctuation">.</span><span class="token function">Square</span><span class="token punctuation">(</span><span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// ASSERT</span>
 
        Assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>expectedSquare<span class="token punctuation">,</span> actualSquare<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>XUnit rozróżnia dwa rodzaje testów - fakty i teorie. Fakty są prawdziwe zawsze, niezależnie od danych testowych, teorie tylko dla niektórych.</p>
<p>Spróbujmy przetestować coś korzystającego z naszego repozytorium i wepchnijmy tam jak najwięcej rzeczy o testowaniu. Załóżmy, że mamy metodę, która zwraca losowo wybraną kaczkę, a nasz serwis przyjmuje kolor i zwraca imię kaczki, jeśli trafiliśmy w kolor, a jeśli nie, to rzuca wyjątek. Pomińmy sensowność takiego serwisu i metody w repo.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DuckGuesser</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> IRepository _repository<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">Duck</span><span class="token punctuation">(</span>IRepository repository<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _repository <span class="token operator">=</span> repository<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>    

	<span class="token keyword">public</span> <span class="token keyword">string</span> <span class="token function">GuessColor</span><span class="token punctuation">(</span>Color color<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
	    <span class="token keyword">var</span> duck <span class="token operator">=</span> _repository<span class="token punctuation">.</span><span class="token function">GetRandomDuck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    
	    <span class="token keyword">return</span> duck<span class="token punctuation">.</span>Color <span class="token operator">==</span> color <span class="token operator">?</span> duck<span class="token punctuation">.</span>Name <span class="token punctuation">:</span> <span class="token keyword">throw</span> <span class="token function">ApplicationException</span><span class="token punctuation">(</span>$<span class="token string">"Wrong color, guessed {color}, was {duck.Color}."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DuckGuesserUnitTests</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> TheoryData<span class="token operator">&lt;</span>Duck<span class="token operator">&gt;</span> DuckData <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">new</span> <span class="token class-name">TheoryData</span><span class="token operator">&lt;</span>Duck<span class="token operator">&gt;</span>
    <span class="token punctuation">{</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">Duck</span><span class="token punctuation">(</span><span class="token string">"Jacuś"</span><span class="token punctuation">,</span> Color<span class="token punctuation">.</span>Yellow<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">Duck</span><span class="token punctuation">(</span><span class="token string">"Jacuś"</span><span class="token punctuation">,</span> Color<span class="token punctuation">.</span>Red<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">Duck</span><span class="token punctuation">(</span><span class="token string">"Yellow"</span><span class="token punctuation">,</span> Color<span class="token punctuation">.</span>Yellow<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">Duck</span><span class="token punctuation">(</span><span class="token string">"Yellow"</span><span class="token punctuation">,</span> Color<span class="token punctuation">.</span>Green<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">[</span>Theory<span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token function">MemberData</span><span class="token punctuation">(</span><span class="token function">nameof</span><span class="token punctuation">(</span>DuckData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">GuessColor_WhenColorMatchesWithGivenDuck_ReturnsDuckName</span><span class="token punctuation">(</span>Duck duck<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// ARRANGE</span>
        <span class="token keyword">var</span> expectedName <span class="token operator">=</span> duck<span class="token punctuation">.</span>Name<span class="token punctuation">;</span>
        <span class="token keyword">var</span> color <span class="token operator">=</span> duck<span class="token punctuation">.</span>Color<span class="token punctuation">;</span>
        
        <span class="token keyword">var</span> repository <span class="token operator">=</span> Substitute<span class="token punctuation">.</span><span class="token generic-method function">For<span class="token punctuation">&lt;</span>IRepository<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        repository<span class="token punctuation">.</span><span class="token function">GetRandomDuck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Returns</span><span class="token punctuation">(</span>duck<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">var</span> systemUnderTest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DuckGuesser</span><span class="token punctuation">(</span>repository<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// ACT</span>
        <span class="token keyword">var</span> resultName <span class="token operator">=</span> systemUnderTest<span class="token punctuation">.</span><span class="token function">GuessColor</span><span class="token punctuation">(</span>color<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// ASSERT</span>
        Assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>expectedName<span class="token punctuation">,</span> resultName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">[</span>Theory<span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token function">MemberData</span><span class="token punctuation">(</span><span class="token function">nameof</span><span class="token punctuation">(</span>DuckData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">GuessColor_WhenColorDoesNotMatchWithGivenDuck_ThrowsApplicationException</span><span class="token punctuation">(</span>Duck duck<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// ARRANGE</span>
        <span class="token keyword">var</span> color <span class="token operator">=</span> duck<span class="token punctuation">.</span>Color <span class="token operator">==</span> Color<span class="token punctuation">.</span>Yellow <span class="token operator">?</span> Color<span class="token punctuation">.</span>Green <span class="token punctuation">:</span> Color<span class="token punctuation">.</span>Yellow<span class="token punctuation">;</span>
        
        <span class="token keyword">var</span> repository <span class="token operator">=</span> Substitute<span class="token punctuation">.</span><span class="token generic-method function">For<span class="token punctuation">&lt;</span>IRepository<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        repository<span class="token punctuation">.</span><span class="token function">GetRandomDuck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Returns</span><span class="token punctuation">(</span>duck<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">var</span> systemUnderTest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DuckGuesser</span><span class="token punctuation">(</span>repository<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// ACT &amp; ASSERT</span>
        Assert<span class="token punctuation">.</span><span class="token generic-method function">Throws<span class="token punctuation">&lt;</span>ApplicationException<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> systemUnderTest<span class="token punctuation">.</span><span class="token function">GuessColor</span><span class="token punctuation">(</span>color<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Ten test zdecydowanie nie jest najlepszy - co można by w nim poprawić?</p>
<h2 id="jak-działa-asp-.net">4. Jak działa ASP .NET?</h2>
<p>Zakładam, że wiemy, jak działa internet, protokół HTTP, że HTML jest statyczny i trzeba niestety używać JS-a itd.</p>
<p>ASP .NET to framework do server-side web-app programming. Potrafi tworzyć ładne strony, generować  HTML-a a także da się w nim zrobić wydajne REST API. My będziemy się skupiać na tworzeniu stron.</p>
<h3 id="dlaczego-asynchroniczne-przetwarzanie-jest-ważne">4.1 Dlaczego asynchroniczne przetwarzanie jest ważne?</h3>
<p>Na serwerze, na którym odpalony jest ASP .NET jest pewna pula wątków, tzw. worker threads. W momencie, w którym dostaniemy HTTP request z zewnątrz, jeden z tych wątków się zrywa i zaczyna na niego odpowiadać. Do zrobienia może mieć sporo, musi najpierw zrobić routing, czyli znaleźć metodę, która ma na zapytanie odpowiedzieć; później wysyła zapytania do serwisów, co w przypadku architektury mikroserwisowej łączy się z wysłaniem czegoś po sieci. Na koniec z reguły trzeba dostać się do bazy danych, a to też trochę trwa. No i jak już w końcu zrobimy to co trzeba, to należy z tym wrócić i wysłać odpowiedź.</p>
<p>Przy prostym zapytaniu, podróż do bazy danych zajmie lwią część czasu odpowiedzi na request. Jeśli serwer czeka kilkanaście milisekund na odpowiedź bazy, to prawdopodobnie nic w tym czasie nie robi. Gdyby tylko dało się np. rzucić request do bazy i zająć się czymś innym, w czasie gdy on się przetwarza…</p>
<h3 id="taskt-oraz-asyncawait">4.2 <code>Task&lt;T&gt;</code> oraz <code>async</code>/<code>await</code></h3>
<p>Wszystkie metody, które</p>
<ul>
<li>wysyłają HTTP requesty,</li>
<li>pytają o coś bazę danych,</li>
<li>wczytują albo zapisują rzeczy do pliku,</li>
</ul>
<p>etc. mają swoje odpowiedniki <code>Async</code> (konwencja nazewnicza <code>MethodNameAsync</code>). Takie metody zwracają obiekty typu <code>Task</code> lub <code>Task&lt;T&gt;</code>, które implementują <code>IAwaitable</code>. Załóżmy, że chcemy wysłać GET request i coś tam zrobić z odpowiedzią.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> HttpClient client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> getTask <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">GetStringAsync</span><span class="token punctuation">(</span><span class="token string">"http://www.example.com/recepticle.aspx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Teraz możemy sobie coś zrobić w międzyczasie. Kiedy będziemy potrzebowali odpowiedzi, robimy <code>await</code>.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">var</span> responseString <span class="token operator">=</span> <span class="token keyword">await</span> getTask<span class="token punctuation">;</span>
</code></pre>
<p><code>IAwaitable&lt;T&gt;</code> gwarantuje, że wywołanie <code>await</code> zwróci nam coś typu <code>T</code> (albo wystrzeli wyjątkiem). Jeśli to zadanie nie zostało zakończone, to zmienimy control flow - wykonanie wróci do miejsca, w którym wywołana została nasza metoda. Trzeba poinformować o tym kompilator keywordem <code>async</code> i zwrócić <code>Task</code> lub <code>Task&lt;T&gt;</code>.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">async</span> Task <span class="token function">SendRequestAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">var</span> getTask <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">GetStringAsync</span><span class="token punctuation">(</span><span class="token string">"http://www.example.com/recepticle.aspx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">SpinRoundAndRoundAndRound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> responseString <span class="token operator">=</span> <span class="token keyword">await</span> getTask<span class="token punctuation">;</span>

    <span class="token function">DoStuffWithResponse</span><span class="token punctuation">(</span>responseString<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Teraz ktokolwiek, kto wywołał tę metodę, może kręcić się w kółko aż mu się nie znudzi i nie zrobi <code>await</code> na zwróconym przez nas <code>Tasku</code>.</p>
<p>W szczególności, nasz worker thread może stwierdzić, że skoro nie ma nic do roboty podczas gdy pakiety lecą sobie w świat do bazy danych, to zajmie się requestem innego użytkownika. W momencie kiedy innermost <code>Task</code> się zakończy, przybiegnie dokończyć swoją pracę (<strong>uwaga:</strong> nie musi to być ten sam wątek).</p>
<h3 id="dygresja-task.run">4.3 Dygresja: <code>Task.Run</code></h3>
<p>O ile programowanie asynchroniczne bardzo się przydaje przy IO-bound operations, to do CPU-bound operations również mamy bardzo proste i skuteczne mechanizmy. Po pierwsze, możemy odpalić dowolne zadanie i skierować je do puli wątków za pomocą <code>Task.Run</code>.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">var</span> task <span class="token operator">=</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">SpinRoundAndRoundAndRound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">SpinRoundAndRoundAndRound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> task<span class="token punctuation">;</span>
</code></pre>
<p>Możemy odpalić tak wiele zadań i poczekać aż wszystkie się skończą, w nadziei, że na wielordzeniowym procesorze dostaniemy speedup.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">decimal</span> pi<span class="token punctuation">;</span>
<span class="token keyword">decimal</span> e<span class="token punctuation">;</span>
<span class="token keyword">decimal</span> one<span class="token punctuation">;</span>

<span class="token keyword">var</span> tasks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token operator">&lt;</span>Task<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> pi <span class="token operator">=</span> <span class="token function">CalculatePi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> e <span class="token operator">=</span> <span class="token function">CalculateE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> one <span class="token operator">=</span> <span class="token function">CalculateOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">WaitAll</span><span class="token punctuation">(</span>tasks<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Uwaga: robienie <code>await</code> jako ostatniej instrukcji w metodzie nie ma absolutnie żadnego sensu. Lepiej zwrócić taki <code>Task</code>.</p>
<h3 id="dygresja-parallel">4.4 Dygresja: <code>Parallel</code></h3>
<p>Mamy też statyczne metody <code>Parallel.For</code> i <code>Parallel.Foreach</code>, które robią to co można się domyślić, że robią. Nie będziemy wnikać w szczegóły.</p>
<h3 id="dygresja-plinq">4.5 Dygresja: PLINQ</h3>
<p>Istnieje też współbieżna wersja LINQ, którą można zawołać konwertując <code>IEnumerable</code> za pomocą <code>AsParallel()</code>, ale o LINQ będzie później.</p>
<h3 id="mvc">4.6 MVC</h3>
<p>ASP .NET Core pozwala na tworzenie aplikacji w dwóch UI architectural design patterns - MVVM (Razor Pages) i MVC. My skupimy się na MVC, które jest już established technologią.</p>
<p>MVC to skrót od Model-View-Controller.</p>
<p><img src="https://upday.github.io/images/blog/mvc/mvc.png" alt="enter image description here"></p>
<ul>
<li><strong>Model</strong> - zawiera logikę biznesową i reprezentuje domenę aplikacji;</li>
<li><strong>View</strong> - wyświetla model i zajmuje się szeroko rozumianą prezentacją danych;</li>
<li><strong>Controller</strong> - reaguje na input użytkownika, wysyłając w odpowiedzi odpowiednie widoki lub informując o tym Model.</li>
</ul>
<p>W ASP .NET MVC widoki to widoki, kontrolery to kontrolery, a model to cała aplikacja pod spodem. Można go podzielić na kilka warstw (np. serwisy i repozytorium).</p>
<h3 id="kontrolery-i-routing">4.7 Kontrolery i routing</h3>
<p>Każdy kontroler ma publiczne metody, zwane akcjami. Każda z nich reprezentuje pewien HTTP request, w przypadku aplikacji UI z reguły GET lub POST. Domyślnie odwołanie się do adresu <code>http://myapp.com/Controller/Action</code> wywoła akcję o nazwie <code>Action</code> w kontrolerze o nazwie <code>Controller</code>. Taka akcja zwraca pochodną <code>ActionResult</code>, która jest wysyłana do klienta. Najczęściej będzie to widok w przypadku apki webowej.</p>
<p>Routing można dowolnie zmieniać i tworzyć własne reguły co i na co jest mapowane.</p>
<h3 id="widoki">4.8 Widoki</h3>
<p>Widoki są pisane w HTML-u z Razorem (rozszerzenie .cshtml), który pozwala na wykonanie kodu w C# podczas generowania HTML-a. Podstawową częścią danego widoku jest Model do niego przekazany. Z reguły nie jest on tożsamy z Modelem z MVC - stanowi tylko jakiś snapshot danych wyciągniętych z bazy danych i przedstawionych w przystępnej formie użytkownikowi. Z tego też powodu często mówi się na nie ViewModels.</p>
<p>Przykładowy widok w .cshtml może wyglądać np. tak:</p>
<pre class=" language-html"><code class="prism  language-html">@{
    ViewData["Title"] = "Home Page";
}
@model IEnumerable<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DuckViewModel</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text-center<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Ducks<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>align-items-center<span class="token punctuation">"</span></span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">="</span><span class="token attr-value"><span class="token property">margin-bottom</span><span class="token punctuation">:</span> <span class="token number">100</span>px</span><span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>table<span class="token punctuation">"</span></span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">="</span><span class="token attr-value"><span class="token property">margin-left</span><span class="token punctuation">:</span> auto<span class="token punctuation">;</span> <span class="token property">margin-right</span><span class="token punctuation">:</span> auto</span><span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>thead</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>th</span><span class="token punctuation">&gt;</span></span>Name<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>th</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>th</span><span class="token punctuation">&gt;</span></span>Owner name<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>th</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>thead</span><span class="token punctuation">&gt;</span></span>
        @foreach (var duck in Model)
        {
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>@duck.Name<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>@duck.UserName<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">&gt;</span></span>
        }

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>table</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span> 

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">asp-action</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Create<span class="token punctuation">"</span></span> <span class="token attr-name">asp-controller</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Duck<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>get<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    &lt;button class="btn btn-primary float-right", type="submit"&gt;
        Create a new duck
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p>Uważny słuchacz zauważy brak takich tagów jak <code>&lt;body&gt;</code> czy <code>&lt;head&gt;</code>. To dlatego, że w pliku <code>_ViewStart.cshtml</code>, który zostaje wczytany na samym początku tworzenia widoku, ustawiony został <code>Layout</code>.</p>
<pre class=" language-html"><code class="prism  language-html"><span class="token comment">&lt;!-- _Layout.cshtml --&gt;</span>
<span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>@ViewData["Title"] - Ducker<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>environment</span> <span class="token attr-name">include</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Development<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>~/lib/bootstrap/dist/css/bootstrap.css<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>environment</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- ... --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>~/css/site.css<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>header</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>nav</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>navbar navbar-expand-sm navbar-toggleable-sm navbar-light bg-white border-bottom box-shadow mb-3<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token comment">&lt;!-- ... --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>nav</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>header</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>main</span> <span class="token attr-name">role</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>main<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>pb-3<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            @RenderBody()
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>main</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>footer</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>border-top footer text-muted<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token entity" title="©">&amp;copy;</span> 2019 - Ducker - <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">asp-area</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token attr-name">asp-controller</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Home<span class="token punctuation">"</span></span> <span class="token attr-name">asp-action</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Privacy<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Privacy<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>footer</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>environment</span> <span class="token attr-name">include</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Development<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>~/lib/jquery/dist/jquery.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>~/lib/bootstrap/dist/js/bootstrap.bundle.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>environment</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- ... --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>~/js/site.js<span class="token punctuation">"</span></span> <span class="token attr-name">asp-append-version</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

    @RenderSection("Scripts", required: false)
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>

</code></pre>
<p>Nasz widok jest wklejany tam, gdzie <code>@RenderBody()</code>.</p>
<h3 id="formularze-i-walidacja">4.9 Formularze i walidacja</h3>
<p>Aby stworzyć np. nową kaczkę, musimy stworzyć kontroler,  który przekaże użytkownikowi odpowiedni widok. Na tym widoku  musi znajdować się formularz z danymi kaczki i przycisk do submitu. Tenże przycisk wywoła inną akcję w kontrolerze, która zapisze kaczkę i przekieruje użytkownika z powrotem na stronę główną.</p>
<p>Napiszmy więc kontroler, będzie potrzebował od nas repozytorium i dwóch akcji <code>Create</code> - jednego GET-a, który zwróci formularz, i jednego POST-a, który przyjmie wypełnione dane kaczki i zapisze ją do repozytorium.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DuckController</span> <span class="token punctuation">:</span> Controller
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> IRepository _repository<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">DuckController</span><span class="token punctuation">(</span>IRepository repository<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _repository <span class="token operator">=</span> repository<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> ActionResult <span class="token function">Create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">View</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CreateDuckViewModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">[</span>HttpPost<span class="token punctuation">]</span>
    <span class="token punctuation">[</span>ValidateAntiForgeryToken<span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> Task<span class="token operator">&lt;</span>ActionResult<span class="token operator">&gt;</span> <span class="token function">Create</span><span class="token punctuation">(</span>CreateDuckViewModel duck<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _repository<span class="token punctuation">.</span>Ducks<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Duck</span> <span class="token punctuation">{</span> Name <span class="token operator">=</span> duck<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> Color <span class="token operator">=</span> duck<span class="token punctuation">.</span>Color<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> _repository<span class="token punctuation">.</span><span class="token function">SaveChangesAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token function">RedirectToAction</span><span class="token punctuation">(</span><span class="token string">"Index"</span><span class="token punctuation">,</span> <span class="token string">"Home"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Upewnijmy się szybko, że skonfigurowaliśmy nasze repozytorium. W ASP .NET mamy statyczną klasę <code>Startup</code>, której metody są wywoływane przy konfiguracji serwera. Znajdziemy tam metodę <code>ConfigureServices(IServiceCollection services)</code>, służącą do skonfigurowania DI.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token comment">/* ... */</span>
services<span class="token punctuation">.</span><span class="token generic-method function">AddDbContext<span class="token punctuation">&lt;</span>DuckerDbContext<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>options <span class="token operator">=</span><span class="token operator">&gt;</span>
    options<span class="token punctuation">.</span><span class="token function">UseNpgsql</span><span class="token punctuation">(</span>Configuration<span class="token punctuation">.</span><span class="token function">GetConnectionString</span><span class="token punctuation">(</span><span class="token string">"DefaultConnection"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
services<span class="token punctuation">.</span><span class="token generic-method function">AddScoped<span class="token punctuation">&lt;</span>IRepository<span class="token punctuation">,</span> DuckerDbContext<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

services<span class="token punctuation">.</span><span class="token function">AddMvc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SetCompatibilityVersion</span><span class="token punctuation">(</span>CompatibilityVersion<span class="token punctuation">.</span>Version_2_2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* ... */</span>
</code></pre>
<p><code>Configuration</code> odwołuje się do pliku <code>appsettings.json</code>.  Tam znajdziemy element <code>"ConnectionStrings"</code>:</p>
<pre class=" language-json"><code class="prism  language-json">  <span class="token string">"ConnectionStrings"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">"DefaultConnection"</span><span class="token punctuation">:</span> <span class="token string">"Host=localhost;Port=5432;Database=ducker_db;UserId=postgres;Password=postgres"</span>
  <span class="token punctuation">}</span>
</code></pre>
<p>Wszystko wygląda w porządku, stwórzmy teraz model. Będziemy potrzebowali drop-down menu z dostępnymi kolorami. Posłużą nam do tego obiekty <code>SelectListItem</code>.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CreateDuckViewModel</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> Color <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        
    <span class="token keyword">public</span> List<span class="token operator">&lt;</span>SelectListItem<span class="token operator">&gt;</span> Colors <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> Color ColorAsEnum <span class="token operator">=</span><span class="token operator">&gt;</span> Enum<span class="token punctuation">.</span><span class="token generic-method function">Parse<span class="token punctuation">&lt;</span>Color<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>Color<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">CreateDuckViewModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">var</span> colorsArray <span class="token operator">=</span> Enum<span class="token punctuation">.</span><span class="token function">GetNames</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>Color<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        Colors <span class="token operator">=</span> colorsArray<span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>c <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">new</span> <span class="token class-name">SelectListItem</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Napotykamy na standardowy kłopot HTML-a - jest statyczny i nie ma pojęcia o naszym kodzie w C# i naszych ładnych <code>enumach</code>. Musi operować na stringach, musimy więc przerobić nasz <code>enum</code> na stringi, a potem wynikowy string z  powrotem na <code>enum</code>.</p>
<p>Teraz przydałaby się nam walidacja. W ASP .NET osiągamy to za pomocą atrybutów. Atrybutów do walidacji jest cała masa, a nawet jeśli nie ma takiego, jakiego byśmy chcieli, to możemy sobie</p>
<p>a) napisać własny i połączyć z JS-em na fronice,<br>
b) użyć <code>RemoteAttribute</code>, który przyjmuje akcję kontrolera zwracającą <code>true</code> lub <code>false</code>.</p>
<p>Pododawajmy więc sobie jakieś atrybuty.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token punctuation">[</span><span class="token function">Display</span><span class="token punctuation">(</span>Name <span class="token operator">=</span> <span class="token string">"Create duck."</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CreateDuckViewModel</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token function">Display</span><span class="token punctuation">(</span>Name <span class="token operator">=</span> <span class="token string">"Name"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token function">MaxLength</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span>Required<span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token function">RegularExpression</span><span class="token punctuation">(</span><span class="token string">@"^(\p{L}+\s?)*$"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token punctuation">[</span><span class="token function">Display</span><span class="token punctuation">(</span>Name <span class="token operator">=</span> <span class="token string">"Color"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span>Required<span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> Color <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> List<span class="token operator">&lt;</span>SelectListItem<span class="token operator">&gt;</span> Colors <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> Color ColorAsEnum <span class="token operator">=</span><span class="token operator">&gt;</span> Enum<span class="token punctuation">.</span><span class="token generic-method function">Parse<span class="token punctuation">&lt;</span>Color<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>Color<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">CreateDuckViewModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">var</span> colorsArray <span class="token operator">=</span> Enum<span class="token punctuation">.</span><span class="token function">GetNames</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>Color<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        Colors <span class="token operator">=</span> colorsArray<span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>c <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">new</span> <span class="token class-name">SelectListItem</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Jesteśmy gotowi do stworzenia widoku.</p>
<pre class=" language-html"><code class="prism  language-html">@model Ducker.Models.CreateDuckViewModel
@{
    ViewData["Title"] = "Create a duck";
}

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h4</span><span class="token punctuation">&gt;</span></span>@Html.DisplayNameFor(model =&gt; model)<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h4</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>row<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>col-md-4<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">asp-action</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Create<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-group<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">asp-for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Name<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">asp-for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Name<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-control<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>    
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">asp-validation-for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Name<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text-danger<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-group<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">asp-for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Color<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">asp-for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Color<span class="token punctuation">"</span></span> <span class="token attr-name">asp-items</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Model.Colors<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-control<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">asp-validation-for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Color<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text-danger<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-group<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Create<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>btn btn-primary<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">asp-action</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Index<span class="token punctuation">"</span></span> <span class="token attr-name">asp-controller</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Home<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Back to List<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}
</code></pre>
<h3 id="identity">4.10 Identity</h3>
<p>ASP .NET Core pozwala na zupełnie bezbolesne zintegrowanie systemu kont z naszą aplikacją. Wystarczy dopisać magiczne linijki w <code>Startup.ConfigureServices</code></p>
<pre class=" language-csharp"><code class="prism  language-csharp">services<span class="token punctuation">.</span><span class="token generic-method function">AddDefaultIdentity<span class="token punctuation">&lt;</span>IdentityUser<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token generic-method function">AddRoles<span class="token punctuation">&lt;</span>IdentityRole<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>AddRoleManager<span class="token operator">&lt;</span>RoleManager<span class="token operator">&lt;</span>IdentityRole<span class="token operator">&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">AddDefaultUI</span><span class="token punctuation">(</span>UIFramework<span class="token punctuation">.</span>Bootstrap4<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token generic-method function">AddEntityFrameworkStores<span class="token punctuation">&lt;</span>DuckerDbContext<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>i w <code>Configure</code></p>
<pre class=" language-csharp"><code class="prism  language-csharp">app<span class="token punctuation">.</span><span class="token function">UseAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Dodatkowo nasza baza danych powinna dziedziczyć po <code>IdentityDbContext</code>, który ma już odpowiednie tabele skonfigurowane.</p>
<p>Teraz możemy zabezpieczyć nasze akcje <code>Create</code> przed dostępem z zewnątrz, oznaczając je atrybutem <code>AuthorizedAttribute</code>, który nie wpuszcza użytkowników niezalogowanych. Można ten mechanizm rozszerzyć o blokowanie użytkowników nienależących do konkretnych ról, np. nieadminów.</p>
<h3 id="co-dalej">4.11 Co dalej?</h3>
<p>ASP .NET jest oczywiście o wiele potężniejszym narzędziem niż tylko maszynką do routingu i generowania widoków. W <code>Startup</code> możemy sobie skonfigurować cały request pipeline - po kolei wszystkie kroki, które nasza aplikacja wykonuje na requeście i responsie. Tag helpery, które już widzieliśmy w postaci <code>asp-for</code> i <code>asp-action</code>/<code>asp-controller</code> pozwalają na proste tworzenie skomplikowanych kontrolek z JS-em w środku. No ale na więcej zabawy nie starczy nam czasu.</p>
<h2 id="jak-działa-entity-framework">5. Jak działa Entity Framework?</h2>
<p>Entity Framework to ORM - Object-Relational Mapping. Służy do połączenia interfejsem środowiska .NET z relacyjną bazą danych. EF korzysta z trzech rzeczy:</p>
<ul>
<li>Model bazy danych - metadane, mówiące EF o bazie danych, z którą się łączy; tabele, relacje, constrainty, indexy etc.;</li>
<li>Encje - obiekty .NET-owe reprezentujące rekordy w bazie;</li>
<li>LINQ to SQL - zintegrowany z C# język zapytań.</li>
</ul>
<h3 id="konfiguracja-bazy---encje-i-metadane">5.1 Konfiguracja bazy - encje i metadane</h3>
<p>Istnieją dwa podejścia do pracy z EF: database-first i code-first. Database-first zakłada, że mamy gotową bazę danych i próbujemy zbudować na niej aplikację. Code-first zakłada, że kod naszej aplikacji i obiekty C#  determinują wygląd bazy danych. There are arguments for both, tutaj będziemy zajmować się wyłącznie code-first.</p>
<p>Potrzebujemy stworzyć pustą bazę danych, skonfigurować ASP .NET, aby się do niej łączył i zacząć tworzyć klasy.</p>
<p>EF potrzebuje klas reprezentujących encje oraz klasy dziedziczącej po <code>DbContext</code>. To ona ma połączenia do bazy danych i udostępnia tabele w postaci właściwości <code>DbSet&lt;T&gt;</code> (implementujących <code>IQueryable&lt;T&gt;</code>).</p>
<p>Spróbujmy stworzyć przykładowy model bazy, mając w ręku ASP .NET Identity i wiedząc, że konta użytkownika są reprezentowane przez <code>IdentityUser</code> z PK na <code>Id</code>.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">namespace</span> Ducker<span class="token punctuation">.</span>Data<span class="token punctuation">.</span>Enums
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">enum</span> Color
    <span class="token punctuation">{</span>
        Yellow<span class="token punctuation">,</span>
        Green<span class="token punctuation">,</span>
        Red<span class="token punctuation">,</span>
        Blue
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token comment">// Entities/Duck.cs</span>
<span class="token keyword">using</span> Ducker<span class="token punctuation">.</span>Data<span class="token punctuation">.</span>Enums<span class="token punctuation">;</span>
<span class="token keyword">using</span> Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Identity<span class="token punctuation">;</span>

<span class="token keyword">namespace</span> Ducker<span class="token punctuation">.</span>Data<span class="token punctuation">.</span>Entities
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Duck</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">string</span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token keyword">int</span> TimesSqueaked <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword">public</span> Color Color <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">string</span> UserId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword">public</span> IdentityUser User <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Tutaj widzimy, w jaki sposób konfigurowane są relacje między encjami: tzw. navigation properties, które są po prostu propertką będącą referencją na related entity w przypadku relacji to-one, a kolekcją referencji w przypadku relacji to-many. Trzymamy też sam FK jako <code>UserId</code> dla wygody.</p>
<p>Aby przygotować constrainty etc. dla naszej bazy danych, musimy przeładować metodę <code>DbContext.OnModelCreating(ModelBuilder)</code> oraz dodać odpowiedni <code>DbSet</code>.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">using</span> Ducker<span class="token punctuation">.</span>Data<span class="token punctuation">.</span>Entities<span class="token punctuation">;</span>
<span class="token keyword">using</span> Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Identity<span class="token punctuation">.</span>EntityFrameworkCore<span class="token punctuation">;</span>
<span class="token keyword">using</span> Microsoft<span class="token punctuation">.</span>EntityFrameworkCore<span class="token punctuation">;</span>

<span class="token keyword">namespace</span> Ducker<span class="token punctuation">.</span>Data
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationDbContext</span> <span class="token punctuation">:</span> IdentityDbContext
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> DbSet<span class="token operator">&lt;</span>Duck<span class="token operator">&gt;</span> Ducks <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token function">ApplicationDbContext</span><span class="token punctuation">(</span>DbContextOptions<span class="token operator">&lt;</span>ApplicationDbContext<span class="token operator">&gt;</span> options<span class="token punctuation">)</span>
            <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token keyword">void</span> <span class="token function">OnModelCreating</span><span class="token punctuation">(</span>ModelBuilder builder<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">OnModelCreating</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>

            builder<span class="token punctuation">.</span><span class="token generic-method function">Entity<span class="token punctuation">&lt;</span>Duck<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
                entity <span class="token operator">=</span><span class="token operator">&gt;</span>
                <span class="token punctuation">{</span>
                    entity<span class="token punctuation">.</span><span class="token function">HasKey</span><span class="token punctuation">(</span>e <span class="token operator">=</span><span class="token operator">&gt;</span> e<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    entity<span class="token punctuation">.</span><span class="token function">Property</span><span class="token punctuation">(</span>e <span class="token operator">=</span><span class="token operator">&gt;</span> e<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">HasMaxLength</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">IsRequired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    entity<span class="token punctuation">.</span><span class="token function">Property</span><span class="token punctuation">(</span>e <span class="token operator">=</span><span class="token operator">&gt;</span> e<span class="token punctuation">.</span>Color<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">IsRequired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    entity<span class="token punctuation">.</span><span class="token function">Property</span><span class="token punctuation">(</span>e <span class="token operator">=</span><span class="token operator">&gt;</span> e<span class="token punctuation">.</span>TimesSqueaked<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">HasDefaultValue</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">IsRequired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    entity<span class="token punctuation">.</span><span class="token function">HasOne</span><span class="token punctuation">(</span>e <span class="token operator">=</span><span class="token operator">&gt;</span> e<span class="token punctuation">.</span>User<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">WithMany</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">HasForeignKey</span><span class="token punctuation">(</span>e <span class="token operator">=</span><span class="token operator">&gt;</span> e<span class="token punctuation">.</span>UserId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Rzeczy związane z Identity są już skonfigurowane w <code>IdentityDbContext</code>. Teraz wystarczy wygenerować migrację, zaaplikować ją do bazy danych i ją podejrzeć. Zobaczymy tabelę wyglądającą tak:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token string">"Ducks"</span>
<span class="token punctuation">(</span>
  <span class="token string">"Name"</span>          <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span>       <span class="token operator">NOT</span> <span class="token boolean">NULL</span>
    <span class="token keyword">CONSTRAINT</span> <span class="token string">"PK_Ducks"</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
  <span class="token string">"TimesSqueaked"</span> <span class="token keyword">INTEGER</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token string">"Color"</span>         <span class="token keyword">INTEGER</span>           <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token string">"UserId"</span>        <span class="token keyword">TEXT</span>
    <span class="token keyword">CONSTRAINT</span> <span class="token string">"FK_Ducks_AspNetUsers_UserId"</span>
    <span class="token keyword">REFERENCES</span> <span class="token string">"AspNetUsers"</span>
    <span class="token keyword">ON</span> <span class="token keyword">DELETE</span> <span class="token keyword">RESTRICT</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token string">"Ducks"</span>
  OWNER <span class="token keyword">TO</span> postgres<span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> <span class="token string">"IX_Ducks_UserId"</span>
  <span class="token keyword">ON</span> <span class="token string">"Ducks"</span> <span class="token punctuation">(</span><span class="token string">"UserId"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>EF postanowił zrobić sobie indeks na FK, no niech mu będzie. Oczywiście mamy na to wpływ, możemy poprosić o inny indeks używając <code>HasIndex</code>. Dzięki <code>FluentAPI</code> możemy praktycznie dowolnie skonfigurować bazę danych. Stored procedures też się da, ale to poza zakresem prezentacji.</p>
<p>Słowo o migracjach: są to po prostu instrukcje dla bazy danych w jaki sposób zaktualizować model bazy i jak to potem cofnąć (prof. Stencel wbiega do sali krzycząc EWOLUCJA MODELU!). Domyślnie zablokowane jest tworzenie migracji, które spowodowałyby utratę danych (i bardzo dobrze).</p>
<h3 id="linq">5.2 LINQ</h3>
<p>Najlepszą część C# zostawiliśmy sobie na koniec. Language Integrated Query - LINQ (czyt. link) - to język zapytań do przetwarzania potokowego kolekcji w C#. Jest to zbiór extension methods zdefiniowanych na <code>IEnumerable</code> (LINQ to Objects), plikach XML (LINQ to XML) oraz bazach pod Entity Frameworkiem (LINQ to Entities).</p>
<p>Zakładając źródło postaci <code>IEnumerable&lt;TSource&gt;</code>, podstawowe operacje to:</p>
<h3 id="select---projekcja">5.3 <code>Select</code> - projekcja</h3>
<p><code>IEnumerable&lt;U&gt; Select(Func&lt;TSource, U&gt;)</code> pozwala na transformację danych. Funkcja jest wywoływana dla każdego elementu i zwracany jest enumerable wyników.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">var</span> ducks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token operator">&lt;</span>Duck<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">new</span> <span class="token class-name">Duck</span><span class="token punctuation">(</span><span class="token string">"Jacuś"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Duck</span><span class="token punctuation">(</span><span class="token string">"Piotruś"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Duck</span><span class="token punctuation">(</span><span class="token string">"Azathoth"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token keyword">var</span> name <span class="token keyword">in</span> ducks<span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>d <span class="token operator">=</span><span class="token operator">&gt;</span> d<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<pre><code>&gt; Jacuś
&gt; Piotruś
&gt; Azathoth
</code></pre>
<h3 id="where---selekcjafiltrowanie">5.4 <code>Where</code> - selekcja/filtrowanie</h3>
<p><code>IEnumerable&lt;TSource&gt; Where(Func&lt;T, bool&gt;)</code> zwraca elementy spełniające dany predykat.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">var</span> values <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">42</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">8</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token keyword">var</span> val <span class="token keyword">in</span> values<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>v <span class="token operator">=</span><span class="token operator">&gt;</span> v <span class="token operator">&gt;=</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<pre><code>&gt; 42
&gt; 21
&gt; 8
</code></pre>
<h3 id="selectmany---spłaszczenie">5.5 <code>SelectMany</code> - spłaszczenie</h3>
<p><code>IEnumerable&lt;TResult&gt; SelectMany(Func&lt;TSource, IEnumerable&lt;TResult&gt;)</code> wyłuskuje enumerable wyników z każdego elementu i łączy (spłaszcza) je w jeden.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">var</span> ducks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token operator">&lt;</span>Duck<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">new</span> <span class="token class-name">Duck</span><span class="token punctuation">(</span><span class="token string">"Jacuś"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Duck</span><span class="token punctuation">(</span><span class="token string">"Piotruś"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token keyword">var</span> letter <span class="token keyword">in</span> ducks<span class="token punctuation">.</span><span class="token function">SelectMany</span><span class="token punctuation">(</span>d <span class="token operator">=</span><span class="token operator">&gt;</span> d<span class="token punctuation">.</span>Name<span class="token punctuation">.</span><span class="token function">ToCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>letter<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token operator">&gt;</span> J
<span class="token operator">&gt;</span> a
<span class="token operator">&gt;</span> c
<span class="token operator">&gt;</span> u
<span class="token operator">&gt;</span> ś
<span class="token operator">&gt;</span> P
<span class="token operator">&gt;</span> i
<span class="token operator">&gt;</span> o
<span class="token operator">&gt;</span> t
<span class="token operator">&gt;</span> r
<span class="token operator">&gt;</span> u
<span class="token operator">&gt;</span> ś
</code></pre>
<h3 id="groupby---grupowanie">5.6 <code>GroupBy</code> - grupowanie</h3>
<p><code>IEnumerable&lt;IGrouping&lt;TKey, TSource&gt;&gt; GroupBy(Func&lt;TSource, TKey&gt;)</code>  grupuje po kluczu; ma wiele przeładowań, może automatycznie robić projekcję wynikowych grupowań i stosować customowe komparatory.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">var</span> ducks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token operator">&lt;</span>Duck<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">new</span> <span class="token class-name">Duck</span><span class="token punctuation">(</span><span class="token string">"Jacuś"</span><span class="token punctuation">,</span> Color<span class="token punctuation">.</span>Yellow<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Duck</span><span class="token punctuation">(</span><span class="token string">"Piotruś"</span><span class="token punctuation">,</span> Color<span class="token punctuation">.</span>Red<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Duck</span><span class="token punctuation">(</span><span class="token string">"Jacuś"</span><span class="token punctuation">,</span> Color<span class="token punctuation">.</span>Green<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token keyword">var</span> grouping <span class="token keyword">in</span> ducks<span class="token punctuation">.</span><span class="token function">GroupBy</span><span class="token punctuation">(</span>d <span class="token operator">=</span><span class="token operator">&gt;</span> d<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"Ducks with name {grouping.Key}:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token keyword">var</span> duck <span class="token keyword">in</span> grouping<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"{duck.Name}, {duck.Color} color"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre><code>&gt; Ducks with name Jacuś:  
&gt; Jacuś, Yellow color  
&gt; Jacuś, Green color  
&gt; Ducks with name Piotruś:  
&gt; Piotruś, Red color
</code></pre>
<h3 id="orderby-thenby---sortowanie">5.7 <code>OrderBy</code>, <code>ThenBy</code> - sortowanie</h3>
<p><code>IOrderedEnumerable&lt;TSource&gt; OrderBy(Func&lt;TSource, TKey&gt;)</code> - sortowanie po kluczu; na wynikowym <code>IOrderedEnumerable</code> można zastosować <code>ThenBy(Func&lt;TSource, TKey&gt;</code>, żeby posortować po drugiej (trzeciej, czwartej…) wartości.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">var</span> ducks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token operator">&lt;</span>Duck<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">new</span> <span class="token class-name">Duck</span><span class="token punctuation">(</span><span class="token string">"Jacuś"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Duck</span><span class="token punctuation">(</span><span class="token string">"Piotruś"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Duck</span><span class="token punctuation">(</span><span class="token string">"Azathoth"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Duck</span><span class="token punctuation">(</span><span class="token string">"Psuchawrl"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token keyword">var</span> duck <span class="token keyword">in</span> ducks<span class="token punctuation">.</span><span class="token function">OrderBy</span><span class="token punctuation">(</span>d <span class="token operator">=</span><span class="token operator">&gt;</span> d<span class="token punctuation">.</span>Name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ThenBy</span><span class="token punctuation">(</span>d <span class="token operator">=</span><span class="token operator">&gt;</span> d<span class="token punctuation">.</span>Name<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>duck<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<pre><code>&gt; Azathoth  
&gt; Jacuś  
&gt; Piotruś  
&gt; Psuchawrl
</code></pre>
<p>Wariantem są <code>OrderByDescending</code> oraz <code>ThenByDescending</code>.</p>
<h3 id="join">5.8 <code>Join</code></h3>
<p><code>Join(IEnumerable&lt;TInner&gt;, Func&lt;TSource,TKey&gt;, Func&lt;TInner,TKey&gt;, Func&lt;TSource,TInner,TResult&gt;)</code> złącza dwa enumerable po kluczach i produkuje rezultat dla każdych dwóch zmatchowanych elementów.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">var</span> ducks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token operator">&lt;</span>Duck<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">new</span> <span class="token class-name">Duck</span><span class="token punctuation">(</span><span class="token string">"Jacuś"</span><span class="token punctuation">,</span> Color<span class="token punctuation">.</span>Yellow<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Duck</span><span class="token punctuation">(</span><span class="token string">"Jacuś"</span><span class="token punctuation">,</span> Color<span class="token punctuation">.</span>Green<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Duck</span><span class="token punctuation">(</span><span class="token string">"Piotruś"</span><span class="token punctuation">,</span> Color<span class="token punctuation">.</span>Yellow<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token keyword">var</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> colorA<span class="token punctuation">,</span> colorB<span class="token punctuation">)</span> <span class="token keyword">in</span> ducks<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>ducks<span class="token punctuation">,</span> d <span class="token operator">=</span><span class="token operator">&gt;</span> d<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> d <span class="token operator">=</span><span class="token operator">&gt;</span> d<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> <span class="token punctuation">(</span>d1<span class="token punctuation">,</span> d2<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>d1<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> d1<span class="token punctuation">.</span>Color<span class="token punctuation">,</span> d2<span class="token punctuation">.</span>Color<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"{name}: {colorA} - {colorB}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<pre><code>&gt; Jacuś: Yellow - Yellow  
&gt; Jacuś: Yellow - Green  
&gt; Jacuś: Green - Yellow  
&gt; Jacuś: Green - Green  
&gt; Piotruś: Yellow - Yellow
</code></pre>
<h3 id="inne">5.9 Inne</h3>
<ul>
<li><code>Distinct</code>, można podać własny komparator;</li>
<li><code>Skip(int)</code> - wyrzuca n elementów z początku;</li>
<li><code>SkipLast(int)</code> - wyrzuca, ale z końca;</li>
<li><code>SkipWhile(Func&lt;TSource, int, bool&gt;)</code> - wyrzuca dopóki predykat jest spełniony;</li>
<li><code>Take</code> - tak jak skip, tylko wybiera elementy zamiast wyrzucać</li>
<li><code>Union</code>, <code>Intersect</code>, <code>Except</code> - suma, przecięcie, różnica dwóch enumerabli</li>
<li><code>Zip</code> - splot, taki <code>Select</code> na dwóch enumerablach  jednocześnie</li>
</ul>
<h3 id="deferred-execution">5.10 Deferred execution</h3>
<p>Wszystkie powyższe metody tak naprawdę się nie wykonują. LINQ buduje sobie plan wykonania zbudowanego query i wykona go dopiero przy enumeracji, to znaczy po wrzuceniu do <code>foreacha</code> albo wykonaniu jednej z operacji, które już muszą zostać wykonane natychmiastowo (agregacje i budowanie kolekcji).<br>
Warto o tym pamiętać, po pierwsze dzięki temu można sobie złożyć zapytanie bardzo szybko z gotowych klocków i odpalić je asynchronicznie. Po drugie należy bardzo unikać tzw. multiple enumerations, przykładowo taki kod:</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">var</span> ducks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token operator">&lt;</span>Duck<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token comment">/* ... */</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> names <span class="token operator">=</span> ducks<span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>d <span class="token operator">=</span><span class="token operator">&gt;</span> d<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Deffered, no projection happens here.</span>

<span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token keyword">var</span> name <span class="token keyword">in</span> ducks<span class="token punctuation">)</span> <span class="token comment">// Enumeration, the query fires.</span>
<span class="token punctuation">{</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token keyword">var</span> name <span class="token keyword">in</span> ducks<span class="token punctuation">)</span> <span class="token comment">// Another enumeration, another execution.</span>
<span class="token punctuation">{</span>
    <span class="token comment">/* ... */</span>
<span class="token punctuation">}</span>
</code></pre>
<p>wywołuje selekcję dwa razy. Wystarczy sobie wyobrazić, że koszt wywołania tamtej metody jest bardzo duży, albo np. operujemy na tabeli w bazie danych i robimy dwa zapytania z tym samym wynikiem zamiast jednego.</p>
<p>Wszystkie kolejne operacje LINQ wymienione w tej prezentacji powodują immediate execution.</p>
<h3 id="tolist---execute">5.11 <code>ToList</code> - execute!</h3>
<p>Klasyka gatunku, jedna z najczęściej używanych operacji. Kiedy chcemy wykonać swoje query i zapisać wynik w <code>List&lt;TResult&gt;</code> wywołujemy <code>ToList()</code>. Można tym też przerobić dowolny <code>IEnumerable</code> na listę, np. <code>Array</code> czy <code>Dictionary</code>.</p>
<p>Koledzy <code>ToList</code> to:</p>
<ul>
<li><code>ToArray</code></li>
<li><code>ToDictionary</code></li>
<li><code>ToHashSet</code></li>
<li><code>ToLookup</code></li>
</ul>
<h3 id="agregacje">5.12 Agregacje</h3>
<p><code>int Max(Func&lt;TSource, int&gt;)</code>,<br>
<code>int Min(Func&lt;TSource, int&gt;)</code>,<br>
<code>int Sum(Func&lt;TSource, int&gt;)</code>,<br>
<code>int Average(Func&lt;TSource, int&gt;)</code><br>
<code>TResult Aggregate(TResult, Func&lt;TResult, TSource, TRessult&gt;)</code> agregują enumerable i zwracają odpowiednio maksimum, minimum, sumę, średnią i dowolną customową agregację.<br>
Istnieją warianty <code>Max</code>, <code>Min</code>, <code>Sum</code> i <code>Average</code> dla wszystkich bazowych typów numerycznych.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">var</span> ducks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token operator">&lt;</span>Duck<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">new</span> <span class="token class-name">Duck</span><span class="token punctuation">(</span><span class="token string">"Jacuś"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Duck</span><span class="token punctuation">(</span><span class="token string">"Piotruś"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Duck</span><span class="token punctuation">(</span><span class="token string">"Azathoth"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Duck</span><span class="token punctuation">(</span><span class="token string">"Psuchawrl"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>ducks<span class="token punctuation">.</span><span class="token function">Aggregate</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> d<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>a <span class="token operator">+</span> d<span class="token punctuation">.</span>Name<span class="token punctuation">.</span>Length<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre><code>&gt; 1
</code></pre>
<h3 id="first-last-single">5.13 <code>First</code>, <code>Last</code>, <code>Single</code></h3>
<p><code>TSource First()</code>, <code>TSource First(Func&lt;TSource, bool&gt;)</code><br>
<code>TSource Last()</code>, <code>TSource Last(Func&lt;TSource, bool&gt;)</code><br>
<code>TSource Single()</code>, <code>TSource Single(Func&lt;TSource, bool&gt;)</code><br>
Wybiera odpowiednio pierwszy, ostatni i jedyny element spełniający dany predykat. Jeśli taki element nie istnieje, rzuca <code>InvalidOperationException</code>.<br>
W przypadku <code>Single</code>, jeśli istnieje więcej niż jeden taki element, również rzuca <code>InvalidOperationException</code>.</p>
<p>Istnieją warianty <code>FirstOrDefault</code>, <code>LastOrDefault</code>, <code>SingleOrDefault</code>, które nie rzucają wyjątku w postaci nieznalezienia żadnego elementu, tylko zwracają <code>default(TSource)</code>.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">var</span> ducks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token operator">&lt;</span>Duck<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">new</span> <span class="token class-name">Duck</span><span class="token punctuation">(</span><span class="token string">"Jacuś"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Duck</span><span class="token punctuation">(</span><span class="token string">"Piotruś"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Duck</span><span class="token punctuation">(</span><span class="token string">"Azathoth"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Duck</span><span class="token punctuation">(</span><span class="token string">"Psuchawrl"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> firstLong <span class="token operator">=</span> ducks<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span>d <span class="token operator">=</span><span class="token operator">&gt;</span> d<span class="token punctuation">.</span>Name<span class="token punctuation">.</span>Length <span class="token operator">&gt;</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>firstLong<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre><code>&gt; Azathoth
</code></pre>
<h3 id="empty">5.14 <code>Empty</code></h3>
<p>True jeśli enumerable pusty, false otherwise. Nuff said.</p>
<h3 id="count">5.15 <code>Count</code></h3>
<p>Zwraca liczbę elementów. Tutaj w szczególności zwróćmy uwagę na deferred execution.</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">var</span> src <span class="token operator">=</span> _repository<span class="token punctuation">.</span>Ducks<span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> src<span class="token punctuation">.</span><span class="token function">Count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">/* ... */</span>
<span class="token punctuation">}</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> src<span class="token punctuation">.</span><span class="token function">Count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">/* ... */</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Powyższy kod powoduje dwa wykonania LINQ i jeśli <code>_repository</code> jest podłączone do bazy danych, to wykona dwa zapytania.</p>
<p>Dodatkowo używanie <code>Count</code> do sprawdzenia pustości, czyli</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">var</span> isEmpty <span class="token operator">=</span> src<span class="token punctuation">.</span><span class="token function">Count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre>
<p>jest skrajnie nieinteligentne, bo zajmuje czas liniowy od wielkości kolekcji.</p>
<h3 id="all-any">5.16 <code>All</code>, <code>Any</code></h3>
<p>Sprawdza, czy predykat zachodzi dla każdego/jakiegokolwiek elementu. Oczywiście nie jest głupie i breakuje wcześnie jeśli odpowiedź jest ustalona.</p>
<h3 id="query-syntax">5.17 Query syntax</h3>
<p>LINQ można też stosować z pseudo-SQLową składnią. Przykładowo:</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">var</span> result <span class="token operator">=</span> ducks
  <span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>d <span class="token operator">=</span><span class="token operator">&gt;</span> d<span class="token punctuation">.</span>Length <span class="token operator">&gt;=</span> <span class="token number">8</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>ducks<span class="token punctuation">,</span> d <span class="token operator">=</span><span class="token operator">&gt;</span> d<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> d <span class="token operator">=</span><span class="token operator">&gt;</span> d<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> <span class="token punctuation">(</span>d1<span class="token punctuation">,</span> d2<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>name<span class="token punctuation">:</span> d1<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> color1<span class="token punctuation">:</span> d1<span class="token punctuation">.</span>Color<span class="token punctuation">,</span> color2<span class="token punctuation">:</span> d2<span class="token punctuation">.</span>Color<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>to to samo co</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">from</span> duck <span class="token keyword">in</span> ducks
<span class="token keyword">where</span> duck<span class="token punctuation">.</span>Name<span class="token punctuation">.</span>Length <span class="token operator">&gt;=</span> <span class="token number">8</span>
<span class="token keyword">join</span> duck2 <span class="token keyword">in</span> ducks on duck<span class="token punctuation">.</span>Name equals duck2<span class="token punctuation">.</span>Name
<span class="token keyword">select</span> <span class="token punctuation">(</span>name<span class="token punctuation">:</span> duck<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> color1<span class="token punctuation">:</span> duck<span class="token punctuation">.</span>Color<span class="token punctuation">,</span> color2<span class="token punctuation">:</span> duck2<span class="token punctuation">.</span>Color<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Joiny wyglądają trochę lepiej, ale to tyle.</p>
<h3 id="linq-to-entities">5.18 LINQ to Entities</h3>
<p>Jeśli będziemy wywoływać LINQ na <code>DbSetach</code>, to wykonanie query spowoduje wysłanie zapytania do bazy danych. Przykładowo</p>
<pre class=" language-csharp"><code class="prism  language-csharp"><span class="token keyword">var</span> theYellowDuckNames <span class="token operator">=</span> ducks
  <span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>d <span class="token operator">=</span><span class="token operator">&gt;</span> d<span class="token punctuation">.</span>Color <span class="token operator">==</span> Color<span class="token punctuation">.</span>Yellow<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>d <span class="token operator">=</span><span class="token operator">&gt;</span> d<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>wywoła SQL</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">SELECT</span> <span class="token number">d</span><span class="token punctuation">.</span><span class="token string">"Name"</span>
<span class="token keyword">FROM</span> <span class="token string">"Ducks"</span> <span class="token keyword">AS</span> <span class="token number">d</span>
<span class="token keyword">WHERE</span> <span class="token number">d</span><span class="token punctuation">.</span><span class="token string">"Color"</span> <span class="token operator">=</span> <span class="token number">0</span>
</code></pre>
<h4 id="include"><code>Include</code></h4>
<p>Zamiast robić joiny, możemy wywoływać domyślne joiny po FK za pomocą <code>Include</code>. Jeśli nie dodamy żadnego <code>Include</code>, standardowo wszystkie navigation properties będą puste, to znaczy kolekcje puste, pojedyncze referencje równe <code>null</code>. Jeśli dodamy <code>Include</code> na tej property, wygeneruje się SQL z odpowiednim Joinem.</p>
<pre class=" language-csharp"><code class="prism  language-csharp">ducks<span class="token punctuation">.</span><span class="token function">Include</span><span class="token punctuation">(</span>d <span class="token operator">=</span><span class="token operator">&gt;</span> d<span class="token punctuation">.</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>d <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>d<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> d<span class="token punctuation">.</span>User<span class="token punctuation">.</span>UserName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">SELECT</span> <span class="token number">d</span><span class="token punctuation">.</span><span class="token string">"Name"</span><span class="token punctuation">,</span> <span class="token string">"d.User"</span><span class="token punctuation">.</span><span class="token string">"UserName"</span>
<span class="token keyword">FROM</span> <span class="token string">"Ducks"</span> <span class="token keyword">AS</span> <span class="token number">d</span>
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> <span class="token string">"AspNetUsers"</span> <span class="token keyword">AS</span> <span class="token string">"d.User"</span> <span class="token keyword">ON</span> <span class="token number">d</span><span class="token punctuation">.</span><span class="token string">"UserId"</span> <span class="token operator">=</span> <span class="token string">"d.User"</span><span class="token punctuation">.</span><span class="token string">"Id"</span>
</code></pre>
<h4 id="insert-update-delete">Insert, Update, Delete</h4>
<p>Jako że <code>DbSet</code> to kolekcja typów referencyjnych, to dodanie do niej nowej encji, zmodyfikowanie z niego wyjętej lub usunięcie spowoduje aktualizację bazy. Nie od razu co prawda, najpierw trzeba wywołać <code>SaveChanges()</code>, które wykonuje wszystkie te operacje w jednej transakcji.</p>
<h4 id="async">Async</h4>
<p>Wszystkie operacje LINQ to Entities, które powodują wykonanie query, mają swoje asynchroniczne odpowiedniki. Jest więc <code>ToListAsync()</code>, <code>SingleAsync(Func&lt;TSource, bool&gt;)</code>, <code>SaveChangesAsync()</code> etc. i to nich powinno się używać.</p>
<h2 id="przykładowa-apka.">6. Przykładowa apka.</h2>
<p>Teraz pokażemy apkę stworzoną w ASP .NET Core z Identity i EF Core w dosłownie pół godziny.</p>
<p>Aby postawić apkę lokalnie należy sklonować repozytorium z <a href="http://github.com/V0ldek/Ducker">http://github.com/V0ldek/Ducker</a> i skonfigurować swoje środowisko.</p>
<p>Instalacja na Windowsie:</p>
<ol>
<li>Pobieramy i instalujemy <a href="https://visualstudio.microsoft.com/downloads/">Visual Studio Community</a>.</li>
<li>Instalujemy rozszerzenie <a href="https://www.jetbrains.com/resharper">ReSharper</a> (wymaga licencji).</li>
<li>Instalujemy bazę danych <a href="https://www.postgresql.org/download/">PostgreSQL</a>
<ul>
<li>port 5432</li>
<li>konto superusera <code>postgres</code>, hasło <code>postgres</code></li>
</ul>
</li>
<li>Uruchamiamy narzędzie <code>psql.exe</code> z PowerShella (najpierw należy je dodać do zmiennej środowiskowej <code>PATH</code>, wchodząc w Zaawansowane ustawienia systemu/Zmienne środowiskowe, tool znajduje się w katalogu instalacji PostgreSQL/bin) pisząc <code>psql -U postgres</code>.</li>
<li>Po podaniu hasła wklepujemy zaklęcie <code>CREATE DATABASE ducker_db;</code>.</li>
<li>Uruchamiamy solucję w VisualStudio (plik Ducker.sln w repo).</li>
<li>Teraz musimy skonfigurować bazę danych. Uruchamiamy Package Manager Console (pasek na dole lub Tools/NuGet Package Manager/Package Manager Console) i piszemy zaklęcie <code>Update-Database</code>, które zastosuje wszystkie migracje do naszej lokalnej bazy danych.</li>
<li>O ile wszystko się udało powinniśmy teraz móc odpalić aplikację wybierając IIS Express i klikając w przycisk z zielonym trójkącikiem na górze.</li>
</ol>
<p>Na Linuxie:</p>
<ol>
<li><a href="https://www.ostechnix.com/how-to-install-microsoft-net-core-sdk-on-linux/">https://www.ostechnix.com/how-to-install-microsoft-net-core-sdk-on-linux/</a></li>
<li>Wybieramy swój edytor, jedyne sensowne opcje to VisualStudio Code i Rider od JetBrainsów.</li>
<li>Instalujemy bazę PostgreSQL tak jak na Windowsie, uruchamiamy <code>psql</code> w terminalu i tworzymy bazę danych <code>ducker_db</code>.</li>
<li>Stosujemy migracje używając .NET Core CLI i zaklęcia <code>dotnet ef database update</code>. W przypadku kłopotów konsultujemy się z <a href="https://docs.microsoft.com/en-us/ef/core/miscellaneous/cli/dotnet">MSDN-em</a></li>
<li>Żeby móc hostować naszą aplikację musimy użyć jakiegoś silnika. Da się to zrobić Dockerem, Nginxem albo Apachem, najlepiej poczytać na <a href="https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/linux-nginx?view=aspnetcore-2.2">MSDN-ie</a>.</li>
</ol>
<p>Przetestujmy apkę tworząc nowe konto użytkownika i tworząc nową kaczkę.</p>
<p>Rola Administrator jest skonfigurowana w metodzie <code>Startup.CreateRoles</code>. W linijce <code>95</code> można zmienić nazwę użytkownika admina, np. na swoją. Administrator widzi kaczki wszystkich użytkowników,  zwykły użytkownik tylko swoje.</p>
<p>Jako ćwiczenie: dodaj funkcjonalność edytowania istniejącej kaczki. Obok każdego wpisu w tabelce na stronie głównej powinien pojawić się przycisk edycji, przekierowujący do formularza edycji (prawdopodobnie pod <code>/Duck/Edit?Name=...</code>). Wysłanie tego formularza powinno poskutkować zapisaniem zmian w bazie danych.</p>
<h2 id="koniec">Koniec</h2>
<p>Dziękuję za uwagę.</p>
<p>Copyright © Mateusz Gienieczko 2019</p>

    </div>
  </div>
</body>

</html>
